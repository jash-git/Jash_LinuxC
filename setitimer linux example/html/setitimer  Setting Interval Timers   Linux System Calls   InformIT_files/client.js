var DISQUS=function(a){var f=a.DISQUS||{};f.AssertionError=function(a){this.message=a};f.AssertionError.prototype.toString=function(){return"Assertion Error: "+(this.message||"[no message]")};f.assert=function(g,h,d){if(!g)if(d)a.console&&a.console.log("DISQUS assertion failed: "+h);else throw new f.AssertionError(h);};var g=[];f.define=function(j,h){typeof j==="function"&&(h=j,j="");for(var d=j.split("."),e=d.shift(),b=f,o=(h||function(){return{}}).call({overwrites:function(b){b.__overwrites__=!0;
return b}},a);e;)b=b[e]?b[e]:b[e]={},e=d.shift();for(var n in o)o.hasOwnProperty(n)&&(!o.__overwrites__&&b[n]!==null&&f.assert(!b.hasOwnProperty(n),"Unsafe attempt to redefine existing module: "+n,!0),b[n]=o[n],g.push(function(b,e){return function(){delete b[e]}}(b,n)));return b};f.use=function(a){return f.define(a)};f.cleanup=function(){for(var a=0;a<g.length;a++)g[a]()};return f}(window);
DISQUS.define(function(a,f){var g=a.DISQUS,j=a.document,h=j.getElementsByTagName("head")[0]||j.body,d={running:!1,timer:null,queue:[]};g.defer=function(e,b){function h(){var b=d.queue;if(b.length===0)d.running=!1,clearInterval(d.timer);for(var e=0,a;a=b[e];e++)a[0]()&&(b.splice(e--,1),a[1]())}d.queue.push([e,b]);h();if(!d.running)d.running=!0,d.timer=setInterval(h,100)};g.each=function(e,b){var a=e.length,h=Array.prototype.forEach;if(isNaN(a))for(var d in e)e.hasOwnProperty(d)&&b(e[d],d,e);else if(h)h.call(e,
b);else for(h=0;h<a;h++)b(e[h],h,e)};g.extend=function(e){g.each(Array.prototype.slice.call(arguments,1),function(b){for(var h in b)e[h]=b[h]});return e};g.serializeArgs=function(e){var b=[];g.each(e,function(e,h){e!==f&&b.push(h+(e!==null?"="+encodeURIComponent(e):""))});return b.join("&")};g.isString=function(e){return Object.prototype.toString.call(e)==="[object String]"};g.serialize=function(e,b,h){b&&(e+=~e.indexOf("?")?e.charAt(e.length-1)=="&"?"":"&":"?",e+=g.serializeArgs(b));if(h)return b=
{},b[(new Date).getTime()]=null,g.serialize(e,b);b=e.length;return e.charAt(b-1)=="&"?e.slice(0,b-1):e};g.require=function(e,b,a,d,f){function p(b){if(b.type=="load"||/^(complete|loaded)$/.test(b.target.readyState))d&&d(),k&&clearTimeout(k),g.bean.remove(b.target,l,p)}var r=j.createElement("script"),l=r.addEventListener?"load":"readystatechange",k=null;r.src=g.serialize(e,b,a);r.async=!0;r.charset="UTF-8";(d||f)&&g.bean.add(r,l,p);f&&(k=setTimeout(function(){f()},2E4));h.appendChild(r);return g};
g.requireStylesheet=function(e,b,a){var d=j.createElement("link");d.rel="stylesheet";d.type="text/css";d.href=g.serialize(e,b,a);h.appendChild(d);return g};g.requireSet=function(e,b,h){var a=e.length;g.each(e,function(e){g.require(e,{},b,function(){--a===0&&h()})})};g.injectCss=function(e){var b=j.createElement("style");b.setAttribute("type","text/css");e=e.replace(/\}/g,"}\n");a.location.href.match(/^https/)&&(e=e.replace(/http:\/\//g,"https://"));b.styleSheet?b.styleSheet.cssText=e:b.appendChild(j.createTextNode(e));
h.appendChild(b)}});
DISQUS.define("JSON",function(){function a(b){return b<10?"0"+b:b}function f(b){e.lastIndex=0;return e.test(b)?'"'+b.replace(e,function(b){var e=n[b];return typeof e==="string"?e:"\\u"+("0000"+b.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+b+'"'}function g(e,a){var d,j,n,l,p=b,u,q=a[e];q&&typeof q==="object"&&typeof q.toJSON==="function"&&!h&&(q=q.toJSON(e));typeof m==="function"&&(q=m.call(a,e,q));switch(typeof q){case "string":return f(q);case "number":return isFinite(q)?String(q):"null";case "boolean":case "null":return String(q);
case "object":if(!q)return"null";b+=o;u=[];if(Object.prototype.toString.apply(q)==="[object Array]"){l=q.length;for(d=0;d<l;d+=1)u[d]=g(d,q)||"null";n=u.length===0?"[]":b?"[\n"+b+u.join(",\n"+b)+"\n"+p+"]":"["+u.join(",")+"]";b=p;return n}if(m&&typeof m==="object"){l=m.length;for(d=0;d<l;d+=1)j=m[d],typeof j==="string"&&(n=g(j,q))&&u.push(f(j)+(b?": ":":")+n)}else for(j in q)Object.hasOwnProperty.call(q,j)&&(n=g(j,q))&&u.push(f(j)+(b?": ":":")+n);n=u.length===0?"{}":b?"{\n"+b+u.join(",\n"+b)+"\n"+
p+"}":"{"+u.join(",")+"}";b=p;return n}}var j={},h=!1;if(typeof Date.prototype.toJSON!=="function")Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()};var d=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,b,o,n={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;j.stringify=function(e,h,d){var a;o=b="";if(typeof d==="number")for(a=0;a<d;a+=1)o+=" ";else typeof d==="string"&&(o=d);if((m=h)&&typeof h!=="function"&&(typeof h!=="object"||typeof h.length!=="number"))throw Error("JSON.stringify");return g("",{"":e})};j.parse=function(b,e){function h(b,
d){var a,f,g=b[d];if(g&&typeof g==="object")for(a in g)Object.hasOwnProperty.call(g,a)&&(f=h(g,a),f!==void 0?g[a]=f:delete g[a]);return e.call(b,d,g)}var a,b=String(b);d.lastIndex=0;d.test(b)&&(b=b.replace(d,function(b){return"\\u"+("0000"+b.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(b.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return a=eval("("+b+")"),
typeof e==="function"?h({"":a},""):a;throw new SyntaxError("JSON.parse");};var p={a:[1,2,3]},r,l;if(Object.toJSON&&Object.toJSON(p).replace(/\s/g,"")==='{"a":[1,2,3]}')r=Object.toJSON;typeof String.prototype.evalJSON==="function"&&(p='{"a":[1,2,3]}'.evalJSON(),p.a&&p.a.length===3&&p.a[2]===3&&(l=function(b){return b.evalJSON()}));(function(){var b=[1,2,3];typeof b.toJSON==="function"&&(b=b.toJSON(),h=!(b&&b.length===3&&b[2]===3))})();if(h||!r||!l)return{stringify:j.stringify,parse:j.parse};return{stringify:r,
parse:l}});
DISQUS.define("Bus",function(){function a(e){e=e.split("/");return e[0]+"//"+e[2]}var f=DISQUS.use("JSON"),g=window.location.hash.slice(1),j=window.parent,h=document.referrer,d={};d.client=a(document.location.href);d.host=h?a(h):d.client;return{origins:d,postMessage:function(e){e.sender=g;e=f.stringify(e);j.postMessage(e,d.host)},sendHostMessage:function(e,b){b=b||[];DISQUS.Bus.postMessage({scope:"host",name:e,data:b})},sendGlobalMessage:function(e,b){b=b||[];DISQUS.Bus.postMessage({scope:"global",name:e,
data:b})}}});_.extend(DISQUS.Bus,Backbone.Events);$(document).ready(function(){var a=window.addEventListener?window.addEventListener:window.attachEvent,f=window.addEventListener?"message":"onmessage";if(!a)throw Error("No event support.");a(f,function(a){var f=DISQUS.Bus,h=a.origin;if(!(h!=f.origins.client&&h!=f.origins.host)){var d;try{d=DISQUS.JSON.parse(a.data)}catch(e){return}a=d.data;switch(d.scope){case "client":f.trigger(a.eventName,a.data)}}},!1)});
DISQUS.define(function(a,f){var g={blocks:{},ISO_8601:"YYYY-MM-DDTHH:mm:ssZ",apiKey:"E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F",bean:require("bean"),debug:!1,browser:{mobile:navigator.userAgent.match(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i)},modules:{},strings:{translations:{}}};g.strings.get=_.bind(function(a){var d=this.translations[a];return d!==f?d:a},g.strings);g.interpolate=function(a,d){return a.replace(/%\(\w+\)s/g,function(e){var e=e.slice(2,-2),b="";e in d?b=
d[e]!==f&&d[e]!==null?d[e].toString():"":DISQUS.logError&&DISQUS.logError("Key `"+e+"` not found in context for: ",a);return b})};g.addBlocks=function(){return function(a){a(DISQUS)}};g.templateGlobals={urls:DISQUS.use("urls"),sso:null,gettext:g.strings.get};g.renderBlock=function(a,d){return DISQUS.blocks[a](g.templateGlobals,d)};g.assureOffset=function(a){return a.indexOf("+")>=0?a:a+"+00:00"};var j=g.Builder=function(){this.accum=[]};_.extend(j.prototype,{put:function(a){this.accum.push(a)},esc:function(a){return String(a).replace(/&/g,
"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},compile:function(){return this.accum.join("")}});return g});
DISQUS.define("urls",function(){var a=DISQUS.debug?"/js/src/embed/next/vglnk.js":"/build/next/alfie.js",f=encodeURIComponent(document.referrer),g={root:"http://disqus.com",media:"http://mediacdn.disqus.com/1359671309",loading:"http://mediacdn.disqus.com/1359671309/html/simple-loading.html",realertime:"//realtime.services.disqus.com",login:"https://disqus.com/next/login/",api:"http://disqus.com/api/3.0/",apiSecure:"https://disqus.com/api/3.0/",logout:"http://disqus.com/logout/?redirect="+f,editProfile:"http://disqus.com/account/",
verifyEmail:"https://disqus.com/next/verify/",authorize:"https://disqus.com/api/oauth/2.0/authorize/",moderate:"http://disqus.com/admin/moderate/",oauth:{twitter:"http://disqus.com/_ax/twitter/begin/",google:"http://disqus.com/_ax/google/begin/",facebook:"http://disqus.com/_ax/facebook/begin/"},avatar:{generic:"http://mediacdn.disqus.com/1359671309/img/next/noavatar92.png"},linkAffiliatorClient:"http://mediacdn.disqus.com/1359671309"+a};window.location.protocol==="https:"&&(g=_.extend(g,{root:"https://disqus.com",
media:"https://securecdn.disqus.com/1359671309",loading:"https://securecdn.disqus.com/1359671309/html/simple-loading.html",api:g.apiSecure,logout:"https://disqus.com/logout/?redirect="+f,editProfile:"https://disqus.com/account/",moderate:"https://disqus.com/admin/moderate/",oauth:{twitter:"https://disqus.com/_ax/twitter/begin/",google:"https://disqus.com/_ax/google/begin/",facebook:"http://disqus.com/_ax/facebook/begin/"},avatar:{generic:"https://securecdn.disqus.com/1359671309/img/next/noavatar92.png"},
linkAffiliatorClient:"https://securecdn.disqus.com/1359671309"+a}));return g});
DISQUS.define("api",function(){function a(a){function h(e){var f=e.originalEvent.origin;DISQUS.urls.apiSecure.slice(0,f.length)===f&&(e=DISQUS.JSON.parse(e.originalEvent.data),e.requestId===d&&(f=e.code===0?a.success:a.error,delete e.requestId,(f||function(){})(e),document.body.removeChild(g),document.body.removeChild(b),$(window).unbind("message",h)))}var d=_.uniqueId("ft_"),e=document.createElement("div"),b=document.createElement("form"),f="frame_"+d,g;e.innerHTML='<iframe name="'+f+'"></iframe>';
g=e.childNodes[0];b.target=f;b.action=a.url.replace(".json",".pm");b.method=a.method||"GET";a.data=_.extend(a.data,{callback:d,referrer:document.referrer});_.each(a.data,function(a,e){a===!0?a=[1]:a===!1?a=[0]:a===null?a=[""]:_.isArray(a)||(a=[a]);_.each(a,function(a){var d=document.createElement("input");d.type="hidden";d.name=e;d.value=a;b.appendChild(d)})});$(window).bind("message",h);document.body.appendChild(g);document.body.appendChild(b);b.submit()}function f(a){a=_.defaults(a,g);a.data=a.data||
{};a.data.api_key=DISQUS.apiKey;return $.ajax(a)}var g={};return{defaults:function(a){var h,d,e;for(h in a)d=a[h],e=g[h],_.isObject(d)&&_.isObject(e)?_.extend(e,d):g[h]=d},headers:function(a){a=_.extend({},g.headers,a);return g.headers=_.pick(a,_.map(a,function(a,d){if(a)return d}))},getURL:function(a,f){f=f||{};if(f.secure||window.location.protocol==="https:")return DISQUS.urls.apiSecure+a;return DISQUS.urls.api+a},ajax:f,call:function(g,h){h=h||{};h.url=DISQUS.api.getURL(g,{secure:h.secure});h.data=
_.extend(h.data||{},{api_key:DISQUS.apiKey});return(h.secure?a:f)(h)}}});(function(a){a.ajax=function(a){a.method=a.type;a.type=a.dataType;delete a.dataType;return DISQUS.api.ajax(a)};a.Collection.prototype.parse=function(a){return a.response}})(Backbone);
DISQUS.define("ga",function(a){var f,g=function(h){f?f(h):a._gaq.push(h)},j={component:1,"package":2,forum:3,version:4,userType:5};return{setCaller:function(a){f=a},setAccount:function(a){g(["_setAccount",a])},setCustomVar:function(a,d){g(["_setCustomVar",j[a],a,d])},trackPageview:function(){g(["_trackPageview"])},trackEvent:function(a,d,e){g(["_trackEvent",d,a,e,1])},setDomainName:function(a){g(["_setDomainName",a])}}});
DISQUS.define("juggler",function(a){var f=(new Date).getTime().toString(10)+Math.floor(Math.random()*1E6).toString(10),g={},j=function(a){g[a]=this;this._emit=null;this.meta={};this.allowedOverwrites=["thread","forum","forum_id","user_id"];this.reservedKeys=this.allowedOverwrites.slice().concat(["imp","event","prev_imp"]);this.preloadBuffer=[]};DISQUS.extend(j.prototype,{disable:function(){this._emit=function(){};this.preloadBuffer=[]},copySettings:function(){return DISQUS.extend({},this.settings,
this.meta)},overwrite:function(a){for(var d=0,e=this.allowedOverwrites.length;d<e;d++){var b=this.allowedOverwrites[d];a.hasOwnProperty(b)&&(this.meta[b]=a[b])}},load:function(g){var d=this;d.settings=g;d.url=g.url;if(g.disable)return void d.disable();if(a.location.protocol==="https:"){if(g.disableSSL)return void d.disable();d.url=d.url.replace("http:","https:")}DISQUS.each(d.allowedOverwrites,function(a){d.meta[a]=g[a]});d.meta.imp=f;d.meta.prev_imp=DISQUS.cookies.read("__jid");DISQUS.cookies.create("__jid",
f,{expiresIn:18E5});d._emit=function(a){DISQUS.each(d.meta,function(b,g){a[g]=d.meta[g]});DISQUS.require(d.url,a,!1)};DISQUS.each(d.preloadBuffer,function(a){d._emit(a)})},emit:function(a,d){d=DISQUS.extend({},d);DISQUS.each(this.reservedKeys,function(a){if(d[a]!=null)throw"Error: cannot overwrite event context '"+a+"'";});d.event=a;this._emit==null?this.preloadBuffer.push(d):this._emit(d)}});return{client:function(a,d){return g[a]||d&&new j(a)},impId:f}});
DISQUS.define("next.intelligence",function(a){function f(a,f){function d(b){if(!(b instanceof DISQUS.next.models.User)&&!(b instanceof DISQUS.next.models.AnonUser))throw Error("determineUserType(user) needs an instance of User/Anonuser");return b.has("remote")?b.get("remote").domain:b.id?"disqus":k?"guest":"not_logged_in"}function e(b){if(f.switches.length>0)b(f.switches);else f.switches.on("reset",b)}var b=f.initialData;if(_.isObject(b)&&!_.isEmpty(b)){var o=DISQUS.ga.setCustomVar,n=DISQUS.ga.trackPageview,
m=function(b){DISQUS.ga.trackEvent(b,p,r)},p="next",r=b.forum.id,l="not_logged_in",k=!1,v=b.features.support_preferred?"plus":b.features.support_priority?"pro":b.features.support_vip?"vip":"free";f.session.on("identify",function y(){var k=this;k.off("identify",y);var w=k.user.id;w&&g.overwrite({user_id:w});e(function(e){if(e.enabled("juggler_thread_onReady")){var d={thread_slug:b.thread.slug,user_type:k.user.get("user_type")||"anon",referrer:a.document.referrer,theme:"next"};g.emit("init_embed",d);
e.enabled("dark_jester")&&(e=DISQUS.juggler.client("jester",!0),e.load(_.extend(g.copySettings(),{url:"http://referrer.disqus.com/juggler/event.js"})),e.emit("init_embed",d))}});l=d(k.user);o("component","embed");o("package",v);o("forum",r);o("version",p);o("userType",l);n();f.session.on("change:id",function(b){var a=l;l=d(b);a!=l&&(o("userType",l),m(l=="not_logged_in"||l=="guest"?"logout":"login"))})});e(function(a){g.load({disable:!a.enabled("juggler_enabled"),url:"http://juggler.services.disqus.com/event.js",
disableSSL:a.enabled("next_disable_ssl_juggler"),thread:b.thread.id,forum:b.forum.id,forum_id:b.forum.pk})});DISQUS.each({inViewport:function(){m("view_embed");f.off("inViewport")},"uiAction:createPost":function(b){l=="not_logged_in"&&(l="guest",o("userType",l));k=!0;b.get("parent")!=null?m("post_comment_reply"):m("post_comment")},"uiAction:postUpvote":function(){m("like_comment")},"uiAction:postDownvote":function(){m("dislike_comment")},"uiAction:threadUpvote":function(){m("like_thread")},"uiAction:postShare":function(b){m("share_comment_"+
b)},"uiAction:threadShare":function(b){m("share_thread_"+b)},"uiAction:navigate":function(b){(b={community:"community",dashboard:"mydisqus",profile:"profile",reactions:"reactions"}[b])&&m("open_"+b)},"uiAction:followUser":function(){m("follow_user")}},function(b,a){f.on(a,b)})}}var g=DISQUS.juggler.client("juggler",!0);return{init:function(g){f(a,g)}}});
DISQUS.define("cookies",function(){return{create:function(a,f,g){a=a+"="+f+"; path=/";g.domain&&(a+="; domain=."+g.domain);g.expiresIn&&(f=new Date,f.setTime(f.getTime()+g.expiresIn),a+="; expires="+f.toGMTString());document.cookie=a},read:function(a){a+="=";for(var f=document.cookie.split(";"),g,j=0;j<f.length;j++){for(g=f[j];g.charAt(0)==" ";)g=g.substring(1,g.length);if(g.indexOf(a)===0)return g.substring(a.length,g.length)}return null},erase:function(a,f){var g=new Date;g.setTime(g.getTime()+
-864E5);g=a+"=; path=/;expires="+g.toGMTString();f.domain&&(g+="; domain=."+f.domain);document.cookie=g}}});
DISQUS.define("next.utils",function(){function a(b){function a(b){b=Number(b).toString(16);return b.length==1?"0"+b:b}if(b.substr(0,1)==="#")return b;var e=/.*?rgb\((\d+),\s*(\d+),\s*(\d+)\)/.exec(b);if(!e||e.length!==4)return"";var b=a(e[1]),d=a(e[2]),e=a(e[3]);return"#"+b+d+e}var f=RegExp("[\\u0021-\\u002F\\u003A-\\u0040\\u005B-\\u0060\\u007B-\\u007E\\u00A1-\\u00BF\\u2010-\\u2027\\u2030-\\u205E\\u2300-\\u23FF\\u2E00-\\u2E7F\\u3001-\\u303F\\uFE10-\\uFE19\\uFE30-\\uFE4F\\uFE50-\\uFE6B\\uFF01-\\uFF0F\\uFF1A-\\uFF20\\uFF3B-\\uFF40\\uFF5B-\\uFF60\\uFF5F-\\uFF64]+$"),g=
{domain:DISQUS.urls.root.split("/")[2],create:function(b,a){DISQUS.cookies.create(b,a,{domain:g.domain,expiresIn:31536E6})},read:DISQUS.cookies.read,erase:function(b){DISQUS.cookies.erase(b,{domain:g.domain})}},j=function(){var b={};return{getItem:function(a){return b.hasOwnProperty(a)?b[a]:null},setItem:function(a,e){b[a]=String(e)},removeItem:function(a){delete b[a]}}}(),h=/^[a-z0-9_.%+\-]+@[0-9a-z.\-]+\.[a-z.]{2,6}$/i,d=function(){function b(){this.state=null;this.queue=[]}_.extend(b.prototype,
{highlight:function(b){this.state===null&&this._load();this.queue.push(b);this.state===2&&this._flush()},_load:function(){var b=this;b.state=1;DISQUS.require("http://mediacdn.disqus.com/1359671309/build/js/highlight.js",{},!1,function(){b.state=2;b._flush()})},_flush:function(){_.chainedDefer(this.queue,function(b){var a=$(b).html();$(b).html(a.replace(/^<br>/,""));hljs.highlightBlock(b)},this)}});return new b}(),e=function(){var b=document.createElement("fakeelement"),a={transition:"transitionend",
OTransition:"otransitionend",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"},e;for(e in a)if(b.style[e]!==void 0)return a[e];return null}();return{attempt:function(b,a){try{_.bind(b,a||{})()}catch(e){return e}return null},extract:function(b,a){for(var e=a.split("."),d=e.shift();d;){if(e.length===0)return b[d];if(!_.isObject(b[d]))return;b=b[d];d=e.shift()}return b},addStylesheetRules:function(b){function a(){var d=_.find(document.styleSheets,function(b){return(b.ownerNode||b.owningElement).id===
e});if(!d)return void setTimeout(a,50);for(var f=0,g=b.length;f<g;f++){var h=1,v=b[f],j=v[0],m="";Object.prototype.toString.call(v[1][0])==="[object Array]"&&(v=v[1],h=0);for(var z=v.length;h<z;h++){var w=v[h];m+=w[0]+":"+w[1]+(w[2]?" !important":"")+";\n"}d.insertRule?d.insertRule(j+"{"+m+"}",d.cssRules.length):d.addRule(j,m,-1)}}var e="css_"+(new Date).getTime(),d=document.createElement("style");d.id=e;document.getElementsByTagName("head")[0].appendChild(d);window.createPopup||d.appendChild(document.createTextNode(""));
a()},escapeColor:function(b){return a(b).replace(/[^#A-Fa-f0-9]/g,"")},makeCORSRequest:function(b,a,e){e=e||function(){};if(typeof XMLHttpRequest=="undefined")return null;var d=new XMLHttpRequest;if("withCredentials"in d)d.open(b,a,!0),d.onreadystatechange=e;else if(typeof XDomainRequest!="undefined"){if(b!=="GET"&&b!=="POST")return null;d=new XDomainRequest;d.open(b,a);d.onload=e}else d=null;return d},hashStorage:j,cookies:g,niceTruncate:function(b,a){if(b.length<=a)return b;var e=b=b.slice(0,a-
1),d=/(^.*\S)\s/.exec(b);d&&(b=d[1]);(d=f.exec(b))&&(b=b.slice(0,b.length-d[0].length));b.length<0.5*e.length&&(b=e);return b+"\u2026"},htmlDecode:function(b){var a=document.createElement("div");a.innerHTML=b;return a.childNodes.length===0?"":a.childNodes[0].nodeValue},isWindowClosed:function(b){if(!b)return!0;try{return b.closed||b.closed===void 0}catch(a){return!0}},validateEmail:function(b){return h.test(b)},updateURL:function(b,a){var e=document.createElement("a"),a=a||{};e.href=b;a.hostname&&
a.hostname.match(/\.$/)&&(a.hostname+=e.hostname);e=_.extend({protocol:e.protocol,hostname:e.hostname,pathname:e.pathname,search:e.search},a);if(!e.pathname.match(/^\//))e.pathname="/"+e.pathname;return e.protocol+"//"+e.hostname+e.pathname+e.search},injectBaseElement:function(a,e){var e=e||document,d=e.createElement("base");d.target="_parent";d.href=a;e.getElementsByTagName("head")[0].appendChild(d)},syntaxHighlighter:d,transitionEndEvent:e}});
DISQUS.define("next.realtime",function(){function a(a,b,d){h.apply(this,arguments);this.name=b||"hose";this.url=DISQUS.urls.realertime+"/api/2/thread/"+a+"?"+this.uid+"_"+b;this.xhr=null;this.marker=0;if(this.continuous=d!==!1)this.interval=1;this._boundOnLoad=_.bind(this.onLoad,this);this._boundOnProgress=_.bind(this.onProgress,this)}function f(a){h.apply(this,arguments);this.websocket=null;this.interval=1;this.url=(window.location.protocol==="https:"?"wss:":"ws:")+DISQUS.urls.realertime+"/ws/2/thread/"+
a;this._boundOnOpen=_.bind(DISQUS.log,DISQUS,"RT: [Socket] Connection established.");this._boundError=_.bind(this.onError,this);this._boundClose=_.bind(this.onClose,this);this._boundMessage=_.compose(_.bind(this.onMessage,this),function(a){return JSON.parse(a.data)})}var g=DISQUS.use("next.utils"),j=function(){},h=function(a){this.thread=a;this.url=null;this.uid=_.uniqueId();this._boundRun=_.bind(this.run,this)};_.extend(h.prototype,Backbone.Events,{onMessage:function(a){var b=a.message_type,d=a.firehose_id;
this.lastEventId=d;DISQUS.log("RT: new message:",b,d);this.trigger(b,{type:b,data:a.message_body,lastEventId:d})}});_.extend(a.prototype,h.prototype,{onLoad:function(){var a=this.xhr;if(!(a.readyState!==void 0&&a.readyState!==4))a.readyState===void 0||a.status!==200?(a.onreadystatechange=j,a.onload=j,this.trigger("error",this),this.continuous&&(this.interval<=120&&(this.interval*=2),DISQUS.logError("RT: Connection error, backing off %s secs",this.interval),_.delay(this._boundRun,this.interval*1E3))):
(this.trigger("success",this),this.continuous&&this.run())},onProgress:function(){var a=this.xhr.responseText,b=0;if(a&&this.marker!==a.length){for(var a=a.slice(this.marker).split("\n"),d,f,g,h=a.length,j=0;j<h;j++)if(d=a[j],b+=d.length+1,f=d.replace(/^\s+|\s+$/g,"")){try{g=JSON.parse(f)}catch(l){if(j===h-1){b-=d.length+1;break}else{DISQUS.log("RT: unable to parse: ",f,d);continue}}this.onMessage(g)}else DISQUS.log("RT: ignoring empty row...");b>0&&(this.marker+=b-1)}},run:function(){var a=this.xhr=
g.makeCORSRequest("GET",this.url,this._boundOnLoad);a.onprogress=this._boundOnProgress;this.xhr=a;this.marker=0;try{a.send()}catch(b){this.xhr=null,DISQUS.log("RT: Attempt to send a CORS request failed.")}}});_.extend(f.prototype,h.prototype,{onError:function(){this.trigger("error",this);this.interval<=120&&(this.interval*=2);DISQUS.logError("RT: Connection error, backing off %s secs",this.interval);_.delay(this._boundRun,this.interval*1E3)},onClose:function(a){a.wasClean&&(DISQUS.log("RT: [Socket] Connection closed. Restarting..."),
this.trigger("close",this),this.run())},run:function(){var a=this.websocket=new WebSocket(this.url);a.onopen=this._boundOnOpen;a.onerror=this._boundError;a.onmessage=this._boundMessage;a.onclose=this._boundClose}});var d;d=window.WebSocket&&WebSocket.CLOSING===2?f:a;return{Firehose:a,Socket:f,Pipe:d}});
DISQUS.define("next.models",function(){function a(b,d,e){var f=a.pool(b),g=d&&d[b.prototype.idAttribute];if(!g)return new b(d,e);a.get(b,g)?f[g].set(d):f[g]=new b(d,e);return f[g]}var f=DISQUS.use("next.collections"),g=DISQUS.use("next.utils"),j=DISQUS.use("Bus"),h=DISQUS.strings.get;a.pool={};a.pool=function(b){b=a.pool[b.__type__];if(!b)throw Error("Model not registered. Use UniqueModel.addType");return b};a.get=function(b,d){return a.pool(b)[d]};a.addType=function(b,d){if(!d.__type__||!a.pool[b])d.__type__=
b,a.pool[b]={}};var d=Backbone.Model.extend({defaults:{settings:{}}}),e={getRelativeCreatedAt:function(){var a=this.get("createdAt");if(a)return a=DISQUS.assureOffset(a),moment(a,DISQUS.ISO_8601).fromNow()}},b=Backbone.Model.extend({defaults:{author:null,category:null,createdAt:null,forum:null,identifiers:[],ipAddress:null,isClosed:!1,isDeleted:!1,hasStreaming:!1,link:null,message:null,slug:null,title:null,userSubscription:!1,posts:0,reactions:0,likes:0,dislikes:0,userScore:0},initialize:function(a,
b){var d=this,b=b||{};d.moderators=b.moderators;d.forum=b.forum;d.users=new f.UserCollection(b.users,{thread:d});d.posts=new f.PostCollection(b.posts,{thread:d,cursor:b.postCursor});d.reactions=new f.ReactionsCollection(null,{thread:d});d.votes=new f.ThreadVoteCollection;d.posts.bind("add reset",function(a){a=a.models?a.models:[a];_.each(a,function(a){d.users.get(a.author.id)||d.users.add(a.author)})});d.posts.bind("destroy",function(){d.set("posts",d.get("posts")-1)});d.bind("change:posts",d.broadcastPostCount,
d);d.queue=new f.QueuedPostCollection(null,{thread:d})},_vote:function(a,b){var d=a-b;if(d===0)return d;this.set("likes",this.get("likes")+d);return d},vote:function(a){var b=this;b._vote(a,b.get("userScore"))!==0&&(this.set("userScore",a),DISQUS.api.call("threads/vote.json",{data:{thread:this.id,vote:a},method:"POST",success:function(d){d.response.id&&(b.votes.get(d.response.id)||b.votes.add({id:d.response.id,score:a}))}}))},broadcastPostCount:function(){j.sendGlobalMessage("lounge.updateCounter",
{count:this.get("posts")})},fetch:function(a){var b=this,d=b.attributes,a=a||{};DISQUS.api.call("threads/details.json",{data:{thread:d.identifier?"ident:"+d.identifier:"link:"+d.url,forum:d.forum},success:function(d){b.set(d.response);a.success&&a.success()},error:function(){DISQUS.debug?b.save({},{success:a.success}):console.log("Couldn't find thread; not creating in production.")}})},_toggleState:function(a,b){b||(b={});var d=a?"open.json":"close.json";this.set("isClosed",!a);DISQUS.api.call("threads/"+
d,{method:"POST",data:{thread:this.id},success:b.success,error:b.error})},open:function(a){this._toggleState(!0,a)},close:function(a){this._toggleState(!1,a)},sync:function(){var a=this,b=a.attributes;DISQUS.api.call("threads/create.json",{data:{title:b.title,forum:b.forum,identifier:b.identifier,url:b.url},method:"POST",success:function(b){a.set(b.response)}})},incrementPostCount:function(a){this.set("posts",this.get("posts")+a)},isModerator:function(a){if(this.moderators)return a=a instanceof k||
_.isObject(a)?a.id:a,a=parseInt(a,10),_(this.moderators).contains(a)},subscribe:function(a,b){var a=a!==!1,d=this.get("userSubscription");if(d!=a){a?this.set("userSubscription",b||!0):this.set("userSubscription",!1);var e={thread:this.id};if(b)e.email=b;else if(!a&&typeof d==="string")e.email=d;DISQUS.api.call("threads/"+(a?"subscribe.json":"unsubscribe.json"),{data:e,method:"POST"})}},relatedIds:function(){var a=this.get("forum");_.isObject(a);return{forum:this.get("forum"),thread:this.id}},twitterText:function(a){var a=
140-(a.length+1),b=DISQUS.next.utils.htmlDecode(this.get("title"));return b=DISQUS.next.utils.niceTruncate(b,a)},url:function(){var a=this.get("url")||this.get("link");if(!a&&this.currentUrl)a=this.currentUrl;return a}}),o=b.extend({defaults:_.extend({postsInInterval:0,topPost:null},b.prototype.defaults)}),n=Backbone.Model.extend({defaults:function(){return{createdAt:moment().format(DISQUS.ISO_8601),dislikes:0,isApproved:!0,isDeleted:!1,isEdited:!1,isFlagged:!1,isHighlighted:!1,isRealtime:!1,isImmediateReply:!1,
isMinimized:null,message:null,raw_message:null,likes:0,media:[],parent:null,points:0,depth:0,userScore:0}},initialize:function(){this.votes=new f.VoteCollection;this.usersTyping=new f.TypingUserCollection},set:function(b,d,e){if(b&&typeof b!=="string"&&b.author)this.author=new a(k,b.author),delete b.author;return Backbone.Model.prototype.set.call(this,b,d,e)},messageText:function(){var a=this.get("message");return _.strip(a)},relatedIds:function(){var a=this.get("forum");if(_.isObject(a))a=a.id;var b=
this.get("thread");if(_.isObject(b))b=b.id;return{forum:a,thread:b,post:this.id}},twitterText:function(a){var b=140,d;d=this.author.get("name")||this.author.get("username");b-=d.length+3;b-=a.length+1;b-=2;a=this.messageText();a=DISQUS.next.utils.niceTruncate(a,b);return'"'+a+'" \u2014 '+d},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);a.isMinimized=this.get("isMinimized")===!1?!1:!this.get("isApproved");if(this.author)a.author=this.author.toJSON();a.relativeCreatedAt=this.getRelativeCreatedAt();
a.formattedCreatedAt=this.getFormattedCreatedAt();return a},getFormattedCreatedAt:function(){var a=this.get("createdAt");if(!a)return null;a=DISQUS.assureOffset(a);return moment.utc(a,DISQUS.ISO_8601).local().format("LLLL")},validate:function(a){if(!this.id&&!a.id){if(_.isString(a.raw_message)){if(a.raw_message==="")return h("Comments can't be blank.");if(a.raw_message.length<2)return h("Comments must have at least 2 characters.")}if(a.author_email===""&&a.author_name==="")return h("Please sign in or enter a name and email address.");
else if(a.author_email===""||a.author_name==="")return h("Please enter both a name and email address.");if(_.isString(a.author_email)&&!g.validateEmail(a.author_email))return h("Invalid email address format.")}},report:function(){this.set("isFlagged",!0);DISQUS.api.call("posts/report.json",{data:{post:this.id},method:"POST"})},_vote:function(a,b){var d=a-b,e={likes:this.get("likes"),dislikes:this.get("dislikes"),points:this.get("points")};if(d===0)return d;a>0?(e.likes+=a,e.dislikes+=b):a<0?(e.dislikes-=
a,e.likes-=b):b>0?e.likes-=b:e.dislikes+=b;e.points+=d;this.set(e);return d},vote:function(a){var b=this;b._vote(a,b.get("userScore"))!==0&&(b.set("userScore",a),DISQUS.api.call("posts/vote.json",{data:{post:b.id,vote:a},method:"POST",success:function(a){b.votes.add({id:a.response.id})}}))},_delete:function(){this.set({isApproved:!1,isDeleted:!0});DISQUS.api.call("posts/remove.json",{data:{post:this.id},method:"POST"})},spam:function(){this.set({isApproved:!1,isDeleted:!0,isSpam:!0});this.trigger("spam");
DISQUS.api.call("posts/spam.json",{data:{post:this.id},method:"POST"})},_create:function(a,b){var d=this,e=a.attributes,f={thread:e.thread,message:e.raw_message};if(e.recaptcha_challenge_field)f.recaptcha_challenge_field=e.recaptcha_challenge_field,f.recaptcha_response_field=e.recaptcha_response_field;if(e.parent)f.parent=e.parent;if(e.author_name)f.author_name=e.author_name,f.author_email=e.author_email;DISQUS.api.call("posts/create.json",{data:f,method:"POST",success:function(a){d.set(a.response);
b.success&&b.success()},error:b.error})},_update:function(a,b){var d=this,e=a.attributes;DISQUS.api.call("posts/update.json",{data:{post:e.id,message:e.raw_message},method:"POST",success:function(a){d.set(a.response);b.success&&b.success()},error:b.error})},_read:function(a,b){var d=this,b=b||{};DISQUS.api.call("posts/details.json",{data:{post:d.id},method:"GET",success:function(a){d.set(a.response);b.success&&b.success()},error:b.error})},sync:function(a,b,d){var d=d||{},e=d.error;if(e)d.error=function(a){e(JSON.parse(a.responseText||
"{}"))};switch(a){case "create":this._create(b,d);break;case "update":this._update(b,d);break;case "delete":this._delete();break;case "read":this._read(b,d)}}});_.extend(n.prototype,e);a.addType("Post",n);var m=Backbone.Model.extend({defaults:{userId:null,message:null,parentId:null,immedReply:!1},initialize:function(){this.set("createdAt",moment().format(DISQUS.ISO_8601))},getVisibleParent:function(a){for(var b=this,d;b.get("parentId");){if(d=a.posts.get(b.get("parentId")))return d;b=a.queue.get(b.get("parentId"));
if(!b)break}return null},toPost:function(b){var d=b.posts.get(this.get("parentId")),d=d?d.get("depth")+1:0,d=new a(n,{id:this.id,thread:b.id,message:this.get("message"),parent:this.get("parentId"),depth:d,createdAt:this.get("createdAt"),isRealtime:!0,isImmediateReply:this.get("immedReply")});d.author=b.users.get(this.get("userId"));return d}}),p=Backbone.Model.extend({defaults:{typing:!0},initialize:function(){this.createdAt=moment()}}),r=Backbone.Model.extend({defaults:{about:null,avatar:{cache:DISQUS.urls.media+
"/images/noavatar92.png",permalink:DISQUS.urls.media+"/images/noavatar92.png"},connections:{},email:null,emailHash:null,isAnonymous:!0,isFollowedBy:!1,isFollowing:!1,joinedAt:null,name:null,profileUrl:null,url:null,username:null,numPosts:null,numFollowing:null,numFollowers:null,numLikesReceived:null},hasValidAvatar:function(a){if(!a)a=this.attributes;return(a=a.avatar)&&a.cache},validate:function(a){if(!this.hasValidAvatar(a))return"None of the avatar related properties can be null, undefined or empty on User models."},
toJSON:function(){var a=Backbone.Model.prototype.toJSON.apply(this,arguments);a.thread={};if(!this.hasValidAvatar())a.avatar=this.defaults.avatar;return a}}),l=r.extend({idAttribute:"emailHash"});a.addType("AnonUser",l);var k=r.extend({fetch:function(a){var b=this,a=a||{},d={};if(b.id)d.user=b.id;else if(b.get("username"))d.user="username:"+b.get("username");return DISQUS.api.call("users/details.json",{data:d,success:function(d){d=d.response;b.set(d);a.success&&a.success(d);a.complete&&a.complete(d)},
error:function(b){a.error&&a.error(b);a.complete&&a.complete(b)}})},toJSON:function(){var a=r.prototype.toJSON.call(this),b=this.collection&&this.collection.thread;a.thread.canModerate=!!b&&b.isModerator(this);return a},_changeFollowState:function(a){var b=this;DISQUS.api.call("users/"+(a?"follow":"unfollow")+".json",{data:{target:b.id},method:"POST",success:function(){b.set("isFollowing",a)}})},follow:function(){this._changeFollowState(!0)},unfollow:function(){this._changeFollowState(!1)},toggleFollowState:function(){this._changeFollowState(!this.get("isFollowing"))}});
a.addType("User",k);var v=k.extend({defaults:_.extend({numPosts:0},k.prototype.defaults)}),B=Backbone.Model.extend({initialize:function(){this.user=new a(l)},_eventProxy:function(){this.trigger.apply(this,arguments)},_setProxy:function(){this.user.on("all",this._eventProxy,this)},_clearProxy:function(){this.user&&this.user.off("all",this._eventProxy,this)},_setUser:function(a){this._clearProxy();this.user=a;this._setProxy();this.notifications=new f.NotificationCollection(null,{user:this.user});this.notifications.on("markRead",
function(a){this.set("notificationCount",this.get("notificationCount")-a.length)},this);this.trigger("change:id",a)},isRegistered:function(){return this.user instanceof k},isAnonymous:function(){return this.user instanceof l},fetch:function(b){var b=b||{},d={};d["_"+(new Date).getTime()]=1;return DISQUS.api.call("users/details.json",{data:d,success:_.bind(function(d){d=d.response;d.id&&this._setUser(new a(k,d));b.success&&b.success(d);b.complete&&b.complete(d)},this),error:_.bind(function(a){b.error&&
b.error(a);b.complete&&b.complete(a)},this)})}}),y=function(){var b=B.extend({defaults:{canReply:!0,canModerate:!1,discoveryVariant:null,mustVerifyEmail:!1,isReadOnly:!1,audienceSyncVerified:!1,notificationCount:null},toJSON:function(){var a=this.user.toJSON.apply(this.user,arguments);a.thread.canReply=this.get("canReply");if(!a.thread.canModerate)a.thread.canModerate=this.get("canModerate");return a},needsAudienceSyncAuth:function(a){return a.get("settings").audienceSyncEnabled&&this.isRegistered()&&
!this.get("audienceSyncVerified")},fetch:function(b){var d=this;if(d._request)d._request.abort(),d._request=null;var b=b||{thread:{}},e={thread:b.thread.id,post:b.thread.posts.pluck("id")};e["_"+(new Date).getTime()]=1;d._request=DISQUS.api.call("embed/threadDetails.json",{data:e,success:function(e){var e=e.response,f={};e.user&&_.extend(f,e.user,{votes:e.votes});d.set(e.session);d.set("discoveryVariant",e.discovery);f.id&&(d._setUser(new a(k,f)),b.thread.users.add(d.user),e.thread&&(b.thread.set("userScore",
e.thread.userScore),b.thread.set("userSubscription",e.thread.userSubscription)));b.success&&b.success(e);d.trigger("identify")},error:function(a){b.error&&b.error(a)},complete:function(a){d._request=null;b.complete&&b.complete(a)}});return d._request},register:function(b,d){var e=this;DISQUS.api.call("internal/users/register.json",{secure:!0,data:{display_name:b.name,email:b.email},method:"POST",success:function(b){e._setUser(new a(k,b.response))},error:d.error||function(){}})},logout:function(){var b=
this;DISQUS.api.call("internal/users/logout.json",{method:"POST",success:function(){b._setUser(new a(l))}})}}),d;return{get:function(){return d=d||new b},setDefaults:function(a){if(d)throw Error("Session defaults cannot be changed after a session instance is created!");return b.defaults=_.extend(b.prototype.defaults,a)},forget:function(){d=null}}}(),z=Backbone.Model.extend({defaults:{score:0}}),w=Backbone.Model.extend({defaults:{score:0}}),C=Backbone.Model.extend({defaults:function(){return{object:{},
type:"",createdAt:moment().format(DISQUS.ISO_8601)}},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this),b=DISQUS.assureOffset(this.get("createdAt"));a.relativeCreatedAt=moment(b,DISQUS.ISO_8601).fromNow();return a}}),u=Backbone.Model.extend({defaults:function(){return{sender:"",timestamp:moment().valueOf(),type:0,formatted:"",theme:"",createdAt:null,post:null}},set:function(a,b){if(a&&typeof a!=="string"&&a.post)this.post=new n(a.post),delete a.post;return Backbone.Model.prototype.set.call(this,
a,b)},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);if(this.post)a.post=this.post.toJSON();a.relativeCreatedAt=this.getRelativeCreatedAt();return a}});_.extend(u.prototype,e);var e=Backbone.Model.extend({defaults:{enabled:!1}}),q=Backbone.Model.extend({defaults:{thread:null,forum:null,body:null,service:{url:null,name:null},url:null,title:null},set:function(b,d){if(b&&typeof b!=="string"){if(b.author)this.author=new a(b.author.id?k:l,b.author),delete b.author;if(b.createdAt)b.relativeCreatedAt=
moment(DISQUS.assureOffset(b.createdAt),DISQUS.ISO_8601).fromNow()}return Backbone.Model.prototype.set.call(this,b,d)},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);if(this.author)a.author=this.author.toJSON();return a},destroy:function(){DISQUS.api.call("reactions/remove.json",{data:{reaction:this.id,forum:this.get("forum")},method:"POST"})}});return{UniqueModel:a,Forum:d,Thread:b,TopThread:o,Post:n,QueuedPost:m,Reaction:q,TypingUser:p,User:k,AnonUser:l,Session:y,BaseSession:B,
TopUser:v,Vote:z,ThreadVote:w,Notification:u,ActivityItem:C,Switch:e}});
DISQUS.define("next.collections",function(){var a=DISQUS.use("next.models"),f=DISQUS.use("next.utils"),g=Backbone.Collection.extend({model:a.ThreadVote}),j=Backbone.Collection.extend({model:_.bind(a.UniqueModel,{},a.User),initialize:function(a,b){Backbone.Collection.prototype.initialize.apply(this,arguments);this.thread=b&&b.thread}}),h=Backbone.Collection.extend({model:a.Vote}),d=Backbone.Collection.extend({PER_PAGE:10,initialize:function(a,b){b=b||{};this.cursor=b.cursor||{}},fetch:function(a){a=
a||{};a.data=_.defaults(a.data||{},{cursor:a.cursor||"",limit:this.PER_PAGE});return Backbone.Collection.prototype.fetch.call(this,a)},more:function(a){function b(a){e.push(a)}var d=this,a=a||{};if(this.cursor.hasNext){var e=[];this.on("add",b);this.fetch(_.extend({},a,{add:!0,cursor:this.cursor.next,success:function(){d.trigger("add:many",e,d,a);d.off("add",b);a.success&&a.success()}}))}else a.error&&a.error()},parse:function(a){this.cursor=a.cursor;return Backbone.Collection.prototype.parse.call(this,
a)}}),e=d.extend({model:a.Notification,url:DISQUS.api.getURL("messagesx/list"),initialize:function(a,b){this.user=b.user;d.prototype.initialize.apply(this,arguments)},markRead:function(){var a=this.getUnread();if(a.length){var b=_.pluck(a,"id");DISQUS.api.call("messagesx/markRead.json",{data:{messages:b},method:"POST"});_.invoke(a,"set","isRead",!0);this.trigger("markRead",b)}},getUnread:function(){return this.filter(function(a){return!a.get("isRead")})}}),b=d.extend({PER_PAGE:50,model:_.bind(a.UniqueModel,
{},a.Post),url:DISQUS.api.getURL("threads/listPostsThreaded"),initialize:function(a,b){d.prototype.initialize.apply(this,arguments);this.thread=b.thread;this.order=f.cookies.read("disqus.order")||"popular"},fetch:function(a){a=a||{};this.order==="popular"?f.cookies.erase("disqus.order"):f.cookies.create("disqus.order",this.order);a=_.extend(a,{data:{limit:this.PER_PAGE,thread:this.thread.id,forum:this.thread.get("forum"),order:this.order}});return d.prototype.fetch.call(this,a)},add:function(a,b){_.isArray(a)||
(a=[a]);for(var d=[],e=0;e<a.length;e++)this.get(a[e].id)||d.push(a[e]);Backbone.Collection.prototype.add.call(this,d,b)}}),o=Backbone.Collection.extend({model:a.QueuedPost,initialize:function(a,b){var d=this;d.thread=b.thread;d.counters={comments:0,replies:{}};d.bind("add",function(a){var b=a.getVisibleParent(d.thread);b?(d.counters.replies[b.id]?d.counters.replies[b.id]+=1:d.counters.replies[b.id]=1,b.id==a.get("parentId")&&a.set("immedReply",!0)):d.counters.comments+=1})},comparator:function(a){return parseInt(a.get("id"),
10)},isDescendant:function(a,b){var c;var d=a.get("parentId"),d=d?this.get(d):null,e={};for(_.each(b,function(a){e[a]=!0});d;){if(e[d.get("id")]===!0)return!0;c=(d=d.get("parentId"))?this.get(d):null,d=c}return!1},drain:function(a){function b(a){var d=[];e.each(function(a){a.get("parentId")===null&&d.push(a.get("id"))});e.reset(e.filter(function(b){if(b.get("parentId")!==null&&!e.isDescendant(b,d))return b;a(b)}));e.counters.comments=0}function d(b){var f=[],g=[],g=e.filter(function(b){var d=b.getVisibleParent(e.thread);
if(!d||d.get("id")!=a)return b;f.push(b)}),f=_.sortBy(f,function(a){return parseInt(a.get("id"),10)});_.each(f,function(a){b(a)});e.reset(g);e.counters.replies[a]=0}var e=this;return(a?d:b)(function(a){e.thread.posts.add(a.toPost(e.thread))})}}),n=Backbone.Collection.extend({model:a.Switch,parse:function(a){return _.map(a,function(a,b){return{id:b,enabled:a}})},enabled:function(a){return(a=this.get(a))?a.get("enabled"):!1}}),m=Backbone.Collection.extend({models:a.TypingUser,initialize:function(){var a=
this;a.gc=null;a.bind("add remove reset",function(){var b=a.count();if(b>0&&a.gc===null)a.gc=setInterval(_.bind(a.cleanup,a),6E4);else if(b<=0&&a.gc!==null)clearInterval(a.gc),a.gc=null},a)},count:function(){var a=0;this.each(function(b){a+=b.get("typing")?1:-1});return a},cleanup:function(){var a=moment();this.reset(this.filter(function(b){return b.createdAt.diff(a,"minutes")>5}))}}),p=Backbone.Collection.extend({model:a.ActivityItem,url:DISQUS.api.getURL("users/listActivity"),initialize:function(a,
b){this.user=b.user;this.include=b.include||null},fetch:function(){var a={user:"username:"+this.user.get("username")};if(this.include)a.include=this.include;Backbone.Collection.prototype.fetch.call(this,{data:a})}}),r=d.extend({model:_.bind(a.UniqueModel,{},a.Post),url:DISQUS.api.getURL("users/listPostActivity")}),l=Backbone.Collection.extend({model:a.TopThread,url:DISQUS.api.getURL("threads/listPopular"),initialize:function(a,b){this.forum=b.forum;this.limit=b.limit},add:function(a,b){_.isArray(a)||
(a=[a]);var d=[];_.each(a,function(a){a.title.match(/^http/i)||d.push(a)});Backbone.Collection.prototype.add.call(this,d,b)},fetch:function(){Backbone.Collection.prototype.fetch.call(this,{data:{forum:this.forum,limit:this.limit,interval:"7d",with_top_post:!0}})}}),k=Backbone.Collection.extend({model:a.TopUser,url:DISQUS.api.getURL("forums/listMostActiveUsers"),initialize:function(a,b){this.forum=b.forum;this.limit=b.limit;this.discardLowRep=b.discardLowRep},fetch:function(){Backbone.Collection.prototype.fetch.call(this,
{data:{forum:this.forum,limit:this.limit}})},parse:function(a){if(!this.discardLowRep)return a.response;return _.filter(a.response,function(a){if(parseFloat(a.rep)>0.7)return a})}}),a=d.extend({PER_PAGE:20,model:a.Reaction,url:DISQUS.api.getURL("threads/listReactions"),initialize:function(a,b){this.thread=b.thread},fetch:function(a){a=a||{};a=_.extend(a,{data:{limit:this.PER_PAGE,thread:this.thread.id}});return d.prototype.fetch.call(this,a)}});return{PaginatedCollection:d,UserCollection:j,PostCollection:b,
ReactionsCollection:a,TypingUserCollection:m,TopUserCollection:k,TopThreadCollection:l,VoteCollection:h,ThreadVoteCollection:g,ActivityCollection:p,PostActivityCollection:r,NotificationCollection:e,QueuedPostCollection:o,SwitchCollection:n}});
DISQUS.define("next.views",function(){function a(c){return(c=c&&c.match(/discovery\-([\w\-]+)/))&&c[1]}function f(c){return function(a){a&&a.preventDefault&&a.preventDefault();c.apply(this,arguments)}}function g(c,a){var b="[data-action^="+a+"]",d=$(c),d=d.is(b)&&d||d.closest(b);return(d.attr("data-action")||":").split(":")[1]}var j=DISQUS.use("next.models"),h=DISQUS.use("next.collections"),d=DISQUS.use("next.utils"),e=DISQUS.use("next.realtime"),b=DISQUS.use("Bus"),o=DISQUS.use("JSON"),n=DISQUS.strings.get,
m,p={_getShortUrl:function(c){var a=this,b=this._shareUrl(),d=b,b=_.extend({url:b,source:"disqus_embed_next"},this.model.relatedIds());DISQUS.api.call("shortener/create.json",{method:"POST",data:b,timeout:5E3,success:function(c){if(c.code===0)d=c.response.url},complete:function(){c.call(a,d)}})},_shareWaitPopup:function(c){return window.open(DISQUS.urls.loading,"_blank",c||"width=550,height=520")},share:function(c){this.sharers[c].call(this)},sharers:{twitter:function(){var c=this._shareWaitPopup();
this._getShortUrl(function(a){c.location=DISQUS.serialize("https://twitter.com/intent/tweet",{url:a,text:this.model.twitterText(a)})})},facebook:function(){var c=this._shareWaitPopup("width=655,height=352");this._getShortUrl(function(a){c.location=DISQUS.serialize("https://www.facebook.com/sharer.php",{u:a})})}}},r={alert:function(c,a){a?_.isString(a)&&(a={type:a}):a={};this._alert&&this._alert.dismiss();var b=this._alert=new O(_.extend({message:c},a));this.updateDom(function(){b.render().$el.prependTo($("#form")[0])});
return b}},l=Backbone.View.extend({events:{"click [data-action^=auth:]":"handleAuth","click [data-action=verify-email]":"verifyEmail","click [data-action=audiencesync]":"audienceSync","click [data-action=profile]":"handleShowProfile","click [data-action=sort]":"handleSort","click [data-action=close-thread]":"closeThread","click [data-action=open-thread]":"openThread","click [data-action=debug]":"renderDebugInfo"},STREAMING_MAX_VISIBLE:250,initialize:function(c){m=this;c=c||{};c=c.jsonData||{};this.initialData=
c.response||{};if(d.extract(c,"response.forum.id"))DISQUS.urls.moderate=d.updateURL(DISQUS.urls.moderate,{hostname:c.response.forum.id+"."});this.theme=d.extract(this.initialData,"theme.base")||{};j.Session.setDefaults(this.initialData.session);this.session=j.Session.get();this.bindSessionEvents();this.forum=new j.Forum;this.initialData&&this.initialData.forum&&this.forum.set(this.initialData.forum);this.thread=new j.Thread(null,{forum:this.forum,postCursor:c.cursor,moderators:(this.initialData.thread||
{}).moderators});this.posts=this.thread.posts;this.switches=new h.SwitchCollection;this.states={templateReady:!1,realtimeIndicatorsCreated:!1,ravenConfigured:!1,inViewport:!1,streamingPaused:!1};this.forum.get("settings").backplaneEnabled&&this.enableBackplane();b.bind("window.inViewport",function(){this.states.inViewport=!0;this.trigger("inViewport")},this);b.bind("window.scrollOffViewport",function(){this.states.inViewport=!1},this);b.bind("switches.changed",function(c){this.switches.reset(this.switches.parse(c));
if(!this.states.ravenConfigured&&this.switches.enabled("next_raven"))Raven.config({servers:["http://disqus.com/raven/api/store/"],logger:"javascript.next",ignoreErrors:["Script error."]}),window.onerror=Raven.process,DISQUS.api.defaults({error:function(c){Raven.captureMessage({name:"API call failed.",message:c})}}),this.states.ravenConfigured=!0;this.switches.enabled("next_comments_truncation_enabled")&&_.invoke(this.postViews,"manageMessageHeight");if(!this.switches.enabled("next_lazy_embed")||this.states.inViewport)this.fetchSession();
else this.on("inViewport",this.fetchSession,this);this.initLinkAffiliator()},this);this.switches.on("reset",function(){DISQUS.defer(_.bind(function(){if(!this.states.templateReady)return!1;return this.thread&&this.thread.id},this),_.bind(this.initRealtime,this))},this);b.bind("init",function(c){m.bootstrap(c)});c={};if(typeof this.initialData==="object"&&!_.isEmpty(this.initialData))c.thread={id:this.initialData.thread.id};b.sendHostMessage("ready",c)},_templateReady:function(){this.updateModeratorText();
this.states.templateReady=!0;this.renderLayout();this.trigger("templateReady")},enableBackplane:function(){this.backplaneCredentialsReady=!1;this.events["click [data-action=logout]"]=function(c){if(this.backplaneCredentialsReady)c.preventDefault(),b.sendHostMessage("backplane.invalidate",{redirectUrl:DISQUS.urls.logout});else return!0};this.session.on("identify",function(){if(this.backplaneCredentialsReady&&!this.session.isRegistered())b.sendHostMessage("backplane.invalidate"),this.backplaneCredentialsReady=
!1,DISQUS.api.headers({Authorization:null})},this);b.bind("login",function(c){c.backplane!==null&&(this.setBackplaneHeaders(c.backplane),this.fetchSession())},this);b.sendHostMessage("loadBackplane")},setBackplaneHeaders:function(c){c="Backplane "+o.stringify({provider:"janrain",message_id_url:c.messageUrl,channel_name:c.channel,forum_id:this.forum.id});this.backplaneCredentialsReady=!0;DISQUS.api.headers({Authorization:c})},bootstrap:function(c){var i=this;i.config=c||{};var s={};if(c.apiKey)s["X-Disqus-Publisher-API-Key"]=
c.apiKey;if(c.remoteAuthS3)s["X-Disqus-Remote-Auth"]=c.remoteAuthS3;_.isEmpty(s)||DISQUS.api.headers(s);c.anchorColor&&function(){var a=d.escapeColor(c.anchorColor);d.addStylesheetRules([[".publisher-anchor-color a",["color",a,!0]],["a.publisher-anchor-color",["color",a,!0]],[".publisher-anchor-hover a:hover",["color",a,!0]],["a.publisher-anchor-hover:hover",["color",a,!0]],[".active .publisher-nav-color:after",["background",a,!0]],[".media-preview .active.publisher-border-color",["border-color",
a,!0]]])}();d.injectBaseElement(c.referrer);if(c.referrer)i.thread.currentUrl=c.referrer;if(c.width)document.body.style.width=c.width+"px";if(c.permalink)i.on("postsRendered",_.once(function(){i.scrollToPost(c.permalink)}));if(c.sso)DISQUS.templateGlobals.sso=c.sso;this.loadTheme(c);i.bind("templateReady",i.renderForm,i);i.bind("templateReady",i.updatePostCount,i);i.bind("templateReady",i.initCommunity,i);i.bind("templateReady",i.initReactions,i);i.bind("templateReady",i.initUserMenu,i);i.bind("templateReady",
i.initThreadVotes,i);i.bind("templateReady",i.initThreadShareMenu,i);i.bind("templateReady",i.initThreadSubscribe,i);i.bind("templateReady",i.renderStreamingToggle,i);i.bind("postsRendered",_.debounce(i.initRealtime,500),i);i.renderBindings([i.thread,"change:likes",i.updateThreadVotes],[i.thread,"change:userScore",i.updateThreadUserScore],[i.thread,"change:posts",i.updatePostCount],[i.thread.posts,"reset",i.redrawPosts],[i.thread.posts,"add",i.addPosts],[i.thread.posts,"remove",i.removePost],[i.thread.posts,
"reset add",i.toggleLoadMorePosts],[i.thread.posts,"reset add",i.toggleNoPosts],[i.thread.reactions,"reset add",i.toggleLoadMoreReactions],[i.session,"change:id",i.updateThreadSessionData],[i.session,"change:id",i.initDashboard]);i.bind("scroll",function(c){i.position=c;if(i.currentSection==="conversation")i.conversationPosition=c});i.bind("scrollOffViewport",function(){i.states.realtimeIndicatorsCreated&&i.currentSection==="conversation"&&(b.sendHostMessage("realtime.hideNorth"),b.sendHostMessage("realtime.hideSouth"))});
i.bind("scroll",function(c){if(i.states.realtimeIndicatorsCreated&&i.currentSection==="conversation"){var a=_.union([this.queueView],_.values(this.postViews)),d=0,e=0;_.each(a,function(a){if(a&&!a.getDirection)a=a.queueView;if(a&&!(a.options.count<=0)){var b=a.getDirection(c);b===1?d+=a.options.count:b===-1&&(e+=a.options.count)}});var a="realtime.hideNorth",s;d>0&&(a="realtime.showNorth",s=DISQUS.renderBlock("realtimeIndicatorText",{num:d,orientation:"north"}));b.sendHostMessage(a,s);a="realtime.hideSouth";
s=void 0;e>0&&(s=DISQUS.renderBlock("realtimeIndicatorText",{num:e,orientation:"south"}),a="realtime.showSouth");b.sendHostMessage(a,s)}},i);b.bind("window.hashchange",function(c){if(a(c))return void b.sendHostMessage("reset");(c=c&&c.match(/comment\-([0-9]+)/))&&i.scrollToPost(c[1])});b.bind("window.scroll",function(c){i.trigger("scroll",c)});b.bind("window.scrollOffViewport",function(){i.trigger("scrollOffViewport")});b.bind("window.resize",i.resize,i);b.bind("realtime.click",function(c){b.sendHostMessage("realtime.hide"+
(c==="north"?"North":"South"));var a=_.union([i],_.toArray(i.postViews)),d,s,a=_.filter(a,function(a){a=a.queueView;if(!a||a.options.count<=0)return!1;var b=c==="north"?1:-1;if(a.getDirection(i.position)!==b)return!1;return!0}),a=_.sortBy(a,function(c){if(c===i)return 0;return c.offset.top}),a=c==="north"?_.last(a):_.first(a);d=a.queueView;a===i?(s=0,d.model.queue.drain(),d.setCount(d.model.queue.length)):(s=a.offset.top-100,d.options.thread.queue.drain(d.model.id),d.setCount(d.options.thread.queue.length));
var e=function(){b.sendHostMessage("scrollTo",{top:s});l.getInstance().off("domReflow",e)};l.getInstance().on("domReflow",e)});i.thread.queue.bind("add reset",i.toggleRealtimeNotifications,i);i.thread.set(this.initialData.thread);i.posts.reset(this.initialData.posts);var e=$("body");i.getTypeface()==="serif"&&e.addClass("serif");i.getColorScheme()==="dark"&&e.addClass("dark");i.bindBusListeners();_.delay(function I(){i.postViews&&!(_.size(i.postViews)<1)&&(_.invoke(i.postViews,"updateRelativeTime"),
_.delay(I,6E4))},6E4);i.currentSection="conversation";i.thread.on("create",function(c){b.sendHostMessage("posts.create",c.toJSON())});var s=$(window),f=e.width(),g=_.debounce(function(){var c=e.width();f!=c&&i.postViews&&(f=c,_.each(i.postViews,function(c){c.manageMessageHeight()}))},50);s.on("resize",g);i.initialized=!0},bindBusListeners:_.once(function(){b.bind("auth:success",function(c){c&&c.sessionId&&DISQUS.api.headers({"X-Sessionid":c.sessionId});this.fetchSession()},this);b.bind("audiencesync:grant",
function(){this.session.set("audienceSyncVerified",!0)},this)}),initLinkAffiliator:function(){if(this.switches.enabled("enable_link_affiliation")&&d.extract(this,"initialData.forum.settings.linkAffiliationEnabled")&&!this.isHttps()&&!this.initLinkAffiliatorCalled){this.initLinkAffiliatorCalled=!0;var c=d.extract(this,"initialData.forum.pk");if(_.isNumber(c)){var a=new P({el:document.body});b.on("affiliationOptions",function ea(c){b.off("affiliationOptions",ea);c&&_.isNumber(c.timeout)&&a.trigger("options.timeout",
c.timeout)});b.sendHostMessage("loadLinkAffiliator",{clientUrl:DISQUS.urls.linkAffiliatorClient,apiUrl:"//links.services.disqus.com/api",key:"cfdfcf52dffd0a702a61bad27507376d",id:c})}}},loadTheme:function(c){var a=this.theme.js,b=this.theme.css;c.themeUrl&&(a=c.themeUrl+"/theme.js",b=c.themeUrl+"/theme.css");var d=function(c,a){return DISQUS.serialize((a||"js")+"!"+c,null,DISQUS.debug)};this.language=c=c.language||this.initialData.forum.language||"en";var a=curl([d(b,"css"),d(a)]),e=_.bind(this._templateReady,
this);c!=="en"&&(a=a.next([d(DISQUS.urls.media+"/build/lang/"+c+".js"),d(DISQUS.urls.media+(DISQUS.debug?"/js/src/lib/moment/lang/":"/build/lang/moment/")+c+".js")]));a.then(e,function(c){e();DISQUS.log(c)})},bindSessionEvents:_.once(function(){this.session.on("change:isReadOnly",function(){this.session.get("isReadOnly")&&this.alert(n("The Disqus comment system is temporarily in maintenance mode. You can still read comments during this time, however posting comments and other actions are temporarily delayed."))},
this);this.session.on("change:discoveryVariant",this.initDiscovery,this)}),fetchSession:function(){this.session.fetch({thread:this.thread})},initRealtimeIndicators:function(){var c=$("html").width()+"px",c={width:c,minWidth:c,maxWidth:c,position:"fixed"},a={contents:DISQUS.renderBlock("realtimeIndicator",{orientation:"north"}),styles:{top:"0"}},d={contents:DISQUS.renderBlock("realtimeIndicator",{orientation:"south"}),styles:{bottom:"0"}};_.defaults(a.styles,c);_.defaults(d.styles,c);b.sendHostMessage("realtime.init",
{north:a,south:d});this.states.realtimeIndicatorsCreated=!0},insertStreamingComments:_.throttle(function(){var c=this.thread.queue;c.drain();_.each(c.counters.replies,function(a,b){c.drain(b)})},1E3),getTypeface:function(){var c=this.forum.get("settings");return c.typeface==="auto"?this.config.typeface:c.typeface},getColorScheme:function(){var c=this.forum.get("settings");return c.colorScheme==="auto"?this.config.colorScheme:c.colorScheme},updateModeratorText:function(){var c=this.forum.get("settings");
if(c.moderatorText)DISQUS.strings.translations.Mod=c.moderatorText},toggleRealtimeNotifications:function(){var c=this,a=c.thread.queue;c.updateDom(function(){_.defer(function(){b.sendHostMessage("fakeScroll")});if(!a.length)return void $("[data-role=realtime-notification]").hide();if(c.thread.get("hasStreaming"))return void c.insertStreamingComments();var d=c.queueView||new E({model:c.thread,el:c.$el.find("button[data-role=realtime-notification]")});c.queueView=d;d.setCount(a.counters.comments);d.render();
_.each(a.counters.replies,function(a,b){var i=c.thread.posts.get(b);if(i){var d=c.postViews[i.cid],e=d.queueView;if(!e)e=new N({thread:c.thread,postView:d,model:i,el:d.$el.find("[data-role=realtime-notification:"+b+"] a")}),d.queueView=e;e.setCount(a);e.render()}})})},renderDebugInfo:f(function(){if(this.session.user.get("isGlobalAdmin")){var c=new Q({Shortname:this.thread.get("forum"),"Thread ID":this.thread.get("id"),"Thread slug":this.thread.get("slug"),"Anchor color":d.escapeColor(this.config.anchorColor)});
c.render();this.updateDom(function(){var a=document.body;a.insertBefore(c.el,a.firstChild)})}}),scrollToPost:function(c,a,d){var e=this;e.currentSection!=="conversation"&&(d=!0);e.mainNav.navTo("conversation");var f=e.$el.find("#post-"+c);f.length?(a=a||0,_.delay(function(){b.sendHostMessage("scrollTo",{top:f.offset().top+a,force:d||null})},100)):DISQUS.api.call("posts/getContext.json",{method:"GET",data:{post:c},success:function(b){b=_.filter(b.response,function(c){return c.thread==e.thread.get("id")});
b.length!==0&&(_.each(b,function(c){e.thread.posts.add(new j.UniqueModel(j.Post,c))}),e.on("domReflow",function I(){e.off("domReflow",I);e.scrollToPost(c,a,d)}))}})},updateThreadSessionData:function(c){c&&(c.get("thread")&&this.thread.set(c.get("thread")),(c=c.get("votes"))&&typeof c==="object"&&_.each(c,function(c,a){var b=this.posts.get(a);b&&b.set("userScore",c)},this))},initDashboard:function(){var c=$("#main-nav [data-nav=dashboard]");if(this.session.isAnonymous())return c.hide();c.show();this.notificationCount=
new H({el:c.find("[data-role=notification-count]")[0],session:this.session,max:99});this.notificationCount.render();this.session.on("change:notificationCount",function(){this.session.get("notificationCount")<=0&&this.notificationCount.remove()},this);this.dashboard=new R({el:"#dashboard",session:this.session,notifications:this.notifications});this.dashboard.render()},initCommunity:function(){this.community=new S({el:document.getElementById("community"),forum:this.forum})},initReactions:function(){this.reactions=
new ja({el:$("#reaction-list")[0],collection:this.thread.reactions,thread:this.thread,session:this.session});this.forum.get("settings").hasReactions&&$("#global-nav").length===0&&(this.thread.reactions.on("reset",function(){$("#reactions").show()}),this.thread.reactions.fetch())},_getLogoutUrl:function(){return this.config.sso&&this.session.user.get("user_type")==="sso"?this.config.sso.logout:DISQUS.urls.logout},initUserMenu:function(){var c=this.userMenu=new z({el:this.$el.find("[data-role=logout]")[0],
session:this.session,thread:this.thread,logoutUrl:this._getLogoutUrl(),referrerUrl:this.config.referrer});this.session.on("change:id",function(){c.logoutUrl=this._getLogoutUrl();c.render()},this);this.thread.on("change:isClosed",this.render,this);c.render()},initThreadShareMenu:function(){this.threadShareMenu=new v({el:$("#thread-share-menu")[0],model:this.thread})},initDiscovery:function(){function c(a){if(!j){if(!d.switches.length)return void d.switches.on("reset",function ia(){d.switches.off("reset",
ia);c(a)});try{DISQUS.runThemeScript&&(DISQUS.runThemeScript(),j=!0),DISQUS.discovery.init(_.extend({},d.config,{isExperiment:!!f.isExperiment,variant:h,thread:d.initialData.thread,forum:d.initialData.forum,switches:d.switches,loungeId:d.el.id,containerId:"discovery",session:e}),a)}catch(b){return void Raven.captureMessage({name:"There is a bug in Discovery JS. Variant: "+h,message:b})}}}function b(c){c.on("allSubviewsRendered",d.updateDom,d);c.on("resize",d.updateDom,d);d.updateDom(function(){c.render()})}
var d=this,e=d.session,f=e.get("discoveryVariant");if(!f)return void DISQUS.log("Discovery seems not enabled. Check Gargoyle switches.");if(!d.states.templateReady)return void d.on("templateReady",function ha(){d.initDiscovery();d.off("templateReady",ha)});var g=a(d.config.parentWindowHash);g&&(f={js:f.js.replace(RegExp(f.name+"\\.js$"),g+".js"),css:f.css.replace(RegExp(f.name+"\\.css$"),g+".css"),name:g,isExperiment:!1});var h,j=!1;h=f.name;curl(["css!"+DISQUS.serialize(f.css,null,DISQUS.debug),
"js!"+DISQUS.serialize(f.js,null,DISQUS.debug)],function(){c(b)});d.initDiscovery=function(){}},toggleLoadMorePosts:function(){var c=this.$el.find("#posts [data-role=more]");this.updateDom(function(){this.thread.posts.cursor.hasNext?c.show():c.hide()},this)},toggleLoadMoreReactions:function(){var c=this.$el.find("#reactions [data-role=more]");this.updateDom(function(){this.thread.reactions.cursor.hasNext?c.show():c.hide()},this)},isHttps:function(){return window.location.protocol==="https:"},isRealtimeEnabled:function(){return!this.thread.get("isClosed")},
realtimeHandlers:{Post:function(c){var c=c.data,a=this.thread;if(!this.thread.get("hasStreaming")||!this.states.streamingPaused){if(!c.id)return void DISQUS.logError("RT: no post ID");if(!c.author||!c.author.id)return void DISQUS.logError("RT: no author or author ID");if(!c.author.name||!c.author.email_md5)return void DISQUS.logError("RT: no author name or email hash");if(!c.post||!c.post.message)return void DISQUS.logError("RT: no post message");if(a.posts.get(c.id)||a.queue.get(c.id))return void DISQUS.log("RT: duplicate: ",
c.id);if(c.type!=="approved")return void DISQUS.log("RT: unnaproved: ",c.id);this.thread.incrementPostCount(1);var b=c.post.parent_post.id;if((b=b!=="0"?b:null)&&!a.posts.get(b)&&!a.queue.get(b))return void DISQUS.log("RT: parent is not on this page: ",c.id);var d=c.author.id,e=a.users.get(d);e||(e=new j.UniqueModel(j.User,{id:d,name:c.author.name,emailHash:c.author.email_md5,isAnonymous:c.author.id==="0"}),c.author.avatar&&e.set("avatar",{cache:c.author.avatar,permalink:c.author.avatar}),a.users.add(e));
a.queue.add({id:c.id,userId:e.get("id"),parentId:b,message:c.post.message})}},Vote:function(c){var a=c.data;if(a.id&&a.vote){var b=this.thread.posts.get(a.vote.recipient_post_id);!(this.session.user.id&&a.vote.voter_id===this.session.user.id)&&b&&(DISQUS.log("RT: Vote for post ",b.id),c=b.votes.get(a.id),c||(DISQUS.log("RT: Creating new vote with id ",a.id),c=new j.Vote({id:a.id}),b.votes.add(c)),a=b._vote(a.vote.vote,c.get("score")),a!==0&&c.set("score",a))}},ThreadVote:function(c){var a=c.data,
b=this.thread;a.id&&a.vote&&!(this.session.user.id&&a.vote.voter_id==this.session.user.id)&&(c=b.votes.get(a.id),c||(c=new j.ThreadVote({id:a.id}),b.votes.add(c)),a=b._vote(a.vote.vote,c.get("score")),a!==0&&c.set("score",a))},IsTyping:function(c){var a=c.data,b=this.thread;a.thread_id==b.id&&a.post.parent_post.id&&(b=b.posts.get(a.post.parent_post.id))&&(b.usersTyping.get(c.lastEventId)||(!(b.usersTyping.count()<=0)||a.typing)&&b.usersTyping.add(new j.TypingUser({id:c.lastEventId,typing:a.typing})))}},
initRealtime:function(){var c=this;if(c.isRealtimeEnabled()&&!c.realtimeConnection){var a=e.Pipe;c.switches.enabled("next_realtime_indicators")&&(c.states.realtimeIndicatorsCreated||c.initRealtimeIndicators());var b=c.realtimeConnection=new a(c.thread.id);_.chain(c.realtimeHandlers).pairs().each(function(a){b.on(a[0],a[1],c)});_.defer(b._boundRun)}},renderBindings:function(){var c=this;_.each(arguments,function(a){var b=a[2];a[0].bind(a[1],function(){var a=arguments;c.states.templateReady?b.apply(c,
a):c.bind("templateReady",function(){b.apply(c,a)})})})},updateDom:function(){var c=_.debounce(function(){this.resize();this.trigger("domReflow")},0);return function(a,b){a&&a.call(b);c.call(this)}}(),initThreadVotes:_.debounce(function(){var c;this.threadVotes&&this.threadVotes.remove();this.threadVotes=c=new B({thread:this.thread,session:this.session});c.on("vote:up",_.bind(this.trigger,this,"uiAction:threadUpvote"));c.on("vote:down",_.bind(this.trigger,this,"uiAction:threadDownvote"));c.render();
this.updateDom(function(){$("#thread-votes").append(c.el)})},200),initThreadSubscribe:function(){this.threadSubscribeButton=new y({session:this.session,thread:this.thread,el:$("#thread-subscribe-button")[0]})},renderStreamingToggle:function(){var c=this;if(c.thread.get("hasStreaming")&&DISQUS.blocks.realtimeToggleButton){var a=$(DISQUS.renderBlock("realtimeToggleButton"));$(a).bind("click",f(function(){c.toggleStreamingRealtime()}));c.updateDom(function(){$("#realtime-toggle").empty();$("#realtime-toggle").append(a[0])})}},
toggleStreamingRealtime:function(){var c=$("#realtime-toggle a.btn");this.states.streamingPaused?(this.states.streamingPaused=!1,c.addClass("pause")):(this.states.streamingPaused=!0,c.removeClass("pause"))},updateThreadVotes:function(){$("#thread-votes [data-role=like-count]").text(this.thread.get("likes"))},updateThreadUserScore:function(){var c=this.thread.get("userScore"),a=$("#thread-votes [data-role=vote-button]");a.removeClass("upvoted").removeClass("downvoted");c>0?a.addClass("upvoted"):c<
0&&a.addClass("downvoted")},updatePostCount:function(){$("#post-count").html(DISQUS.renderBlock("postCount",{count:this.thread.get("posts")}))},swapMain:function(c){var a=this,d=this.$el.find("#main-nav [data-nav=conversation]").parent("li");c!=="conversation"?d.attr("data-dropdown","disabled"):_.defer(function(){d.attr("data-dropdown","enabled")});a.updateDom(function(){a.states.realtimeIndicatorsCreated&&c!="conversation"&&(b.sendHostMessage("realtime.hideNorth"),b.sendHostMessage("realtime.hideSouth"));
var d=a[c];d&&!d.isRendered&&(a.freeze(!0),d.on("render:all",_.once(function(){a.freeze(!1)})),d.show());a.$el.find("[data-role=main]").hide();a.$el.find("[data-role=main]#"+c).show();a.prevSection=a.currentSection;a.currentSection=c});a.trigger("uiAction:navigate",c)},returnToConversation:function(){this.mainNav.navTo("conversation");var c=this.conversationPosition,a=c&&c.pageOffset;a&&this.updateDom(function(){_.delay(function(){b.sendHostMessage("scrollTo",{top:a,relative:"window",force:!0})},
100)},this)},setupNavigation:function(){var c=this;c.globalNav=new T({el:c.$el.find("#global-nav")[0]});c.mainNav=new T({el:c.$el.find("#main-nav")[0]});c.globalNav.on("nav",function(a){c.updateDom(function(){var b=c.$el.find("#form"),d=c.$el.find("#main-nav");switch(a){case "conversation":b.show();d.show();c.swapMain(c.prevSection||a);break;case "reactions":b.hide(),d.hide(),c.swapMain(a)}})});c.mainNav.on("nav",function(a){c.updateDom(function(){c.swapMain(a)})})},renderLayout:function(){function c(c){return function(d){d.preventDefault();
var e=$(d.currentTarget);e.addClass("busy");a.thread[c].more({success:function(){e.removeClass("busy")},error:function(){e.removeClass("busy")}});b.sendHostMessage([c,".paginate"].join(""))}}var a=this;a.setElement($(DISQUS.renderBlock("layout",{thread:_.extend(a.thread.toJSON(),{showReactions:a.forum.get("settings").hasReactions}),order:a.thread.posts.order})).appendTo("body"));var d=a.$el;a.setupNavigation();_.each(["posts","reactions"],function(a){d.delegate("[data-action=more-"+a+"]","click",
c(a))});a.resize();b.sendHostMessage("mainViewRendered")},renderForm:function(){if(this.thread.get("isClosed"))return void this.alert(n("Comments for this thread are now closed."));if(!this.session.get("canReply"))return void this.session.on("change:id",function s(){this.session.off("change:id",s);this.renderForm()},this);var c=new x({thread:this.thread,session:this.session});c.render();this.updateDom(function(){$("#form").prepend(c.el);c.resize()},this);this.resize()},toggleNoPosts:function(){this.updateDom(function(){this.thread.posts.models.length?
$("#no-posts").hide():$("#no-posts").show();$("#post-list").removeClass("loading")},this)},handleShowProfile:f(function(c){c=$(c.currentTarget).attr("data-user");(c=j.UniqueModel.get(j.User,c))&&this.showProfile(c)}),handleSort:f(function(c){var a=$(c.currentTarget),c=a.closest("li"),a=a.attr("data-sort");c.siblings().removeClass("selected");c.addClass("selected");this.thread.posts.order=a;this.thread.posts.fetch();$("#conversation-menu").removeClass("open");$("#posts [data-role=more]").hide();$("#post-list").addClass("loading").empty()}),
closeThread:f(function(){this.thread.close({success:_.bind(b.sendHostMessage,b,"reset"),error:_.bind(this.alert,this,"An error occurred while closing thread. Please try again.","error")})}),openThread:f(function(){this.thread.open({success:_.bind(b.sendHostMessage,b,"reset"),error:_.bind(this.alert,this,"An error occurred while opening thread. Please try again.","error")})}),redrawPosts:function(){var c=this;c.postViews={};c.addPosts(c.thread.posts,{clearDom:!0});_.each(x.open,function(a,b){var d=
c.postViews[b];d&&(d.toggleReply(),d.reply.textarea.set(a.textarea.get()))})},addPosts:_.decorate(Backbone.collectionAddNormalizer(h.PostCollection,j.Post),function(c,a,b){var d=this;if(c.length){var e=[];_.each(c,function(c){var a,i=c.get("parent");i&&(a=(i=d.thread.posts.get(i))&&d.postViews[i.cid]);a=new G({parent:a,model:c,thread:d.thread,session:d.session,created:b.created});d.postViews[c.cid]=a;a.render();c.get("isRealtime")&&d.removeOldPosts.call(d);i?d.postViews[i.cid].attachChild(a):e.push(a.el)});
e.length&&d.updateDom(function(){var a=$("#post-list");b.clearDom&&a.empty();$("#post-list").removeClass("loading");b.created||!c[0].id||c[0].get("isRealtime")?a.prepend(e):a.append(e);d.trigger("postsRendered")})}}),showProfile:function(c){this.switches.enabled("next_profile_modal")?this.showProfileModal(c):this.showProfileTab(c)},showProfileModal:function(c){$(document).trigger("mouseout");b.sendHostMessage("profile.show",{username:c.get("username")})},showProfileTab:function(c){this.profile&&this.profile.remove();
var a=this.profile=new J({user:c,session:this.session});this.freeze(!0);this.updateDom(function(){this.mainNav.clear();$("#profile").empty().append(a.el);this.swapMain("profile");a.show()},this);a.bind("close",function(){this.returnToConversation();this.updateDom(function(){a.remove()},this)},this);a.bind("render:all",_.once(function(){this.freeze(!1)}),this);b.sendHostMessage("scrollTo",{top:0})},removePost:function(c){var a=this.postViews[c.cid];a&&(a.remove(),delete this.postViews[c.cid])},removeOldPosts:_.debounce(function(){if(this.switches&&
this.switches.enabled("next_realtime_cap")){var c=_.size(this.postViews)-this.STREAMING_MAX_VISIBLE;if(!(c<=0))for(var a=this.thread.posts.sortBy(function(c){return moment(c.get("createdAt")).valueOf()}),b,d=0,e=0;d<a.length&&e<=c;d++)if((b=this.postViews[a[d].cid])&&b.childrenNode.children().length===0)this.thread.posts.remove(a[d]),e+=1}},500),resize:function(){var c=$("body").height();if(!this._frozen||!(this._lastHeight&&this._lastHeight>c))this._lastHeight=c,b.sendHostMessage("resize",{height:c})},
freeze:function(c){this._frozen=!!c;this._frozen===!1&&this.resize()},getPostView:function(c){return this.postViews[c]},windowOpen:function(c,a,b){window.open(c,"_blank","width="+a+",height="+b)},authenticate:function(c){var a=this.authServices[c];if(!a)return void DISQUS.log("Unknown authentication service: "+c);if(_.isFunction(a))return a.call(this);this.windowOpen(a.url,a.width,a.height)},handleAuth:f(function(c){this.authenticate(g(c.target,"auth"))}),authServices:{disqus:{url:DISQUS.urls.login,
width:460,height:355},twitter:{url:DISQUS.urls.oauth.twitter,width:650,height:680},facebook:{url:DISQUS.urls.oauth.facebook,width:550,height:300},google:{url:DISQUS.urls.oauth.google,width:650,height:440},sso:function(){var c=parseInt(this.config.sso.width||"800",10),a=parseInt(this.config.sso.height||"500",10),e=window.open(this.config.sso.url,"_blank","width="+c+",height="+a);(function fa(){d.isWindowClosed(e)?b.sendHostMessage("reload"):_.delay(fa,500)})()}},verifyEmail:f(function(){var c=DISQUS.serialize(DISQUS.urls.verifyEmail,
{f:this.forum.id});window.open(c,"_blank","width=460,height=355")}),getAudienceSyncUrl:_.memoize(function(){var c={client_id:this.config.apiKey,scope:"read,write",response_type:"audiencesync",forum_id:this.forum.id};if(window.location.protocol==="https:")c.ssl=1;return DISQUS.serialize(DISQUS.urls.authorize,c)}),audienceSync:f(function(){this.windowOpen(this.getAudienceSyncUrl(),460,355)})});l.getInstance=function(){return m};_.extend(l.prototype,p);_.extend(l.prototype,r);var k=Backbone.View.extend({updateDom:function(c,
a){var b=l.getInstance();b&&b.initialized?b.updateDom(c,a):_.isFunction(c)&&c.call(a)},resize:function(){var c=l.getInstance();c&&c.initialized&&c.resize()}}),v=k.extend({events:{"click [data-action=share:twitter]":"_onShare","click [data-action=share:facebook]":"_onShare"},_onShare:f(function(c){if((c=g(c.target,"share"))&&this.sharers[c])m.trigger("uiAction:threadShare",c),this.share(c)}),_shareUrl:function(){return this.model.url()}});_.extend(v.prototype,p);var B=k.extend({initialize:function(c){_.extend(this,
c)},events:{"click [data-action=upvote]":"upvote"},render:function(){this.setElement($(DISQUS.renderBlock("threadVotes",{thread:this.thread.toJSON(),user:this.session.toJSON()})))},upvote:f(function(){this.vote(1)}),vote:function(c){this.trigger(c===1?"vote:up":"vote:down");var a=this.thread.get("userScore")===c,b;this.thread.vote(a?0:c);a||(b=this.$el.find(".dropdown"),_.defer(function(){b.addClass("open")}))},remove:function(){this.off();Backbone.View.prototype.remove.call(this)}}),y=k.extend({events:{"click [data-action=subscribe]":"subscribe",
"keydown #thread-subscribe-email":"subscribeKeypress"},initialize:function(c){this.thread=c.thread;this.session=c.session;this.thread.on("change:userSubscription",this.updateStatus,this);this.updateStatus();this._boundDocumentClickHandler=_.bind(this._documentClickHandler,this)},updateStatus:function(){this.thread.get("userSubscription")?this.$el.addClass("subscribed"):this.$el.removeClass("subscribed")},subscribe:f(function(){var c=this.thread.get("userSubscription");this.session.isAnonymous()&&
!c?this.showForm():this.thread.subscribe(!c)}),showForm:function(){var c=this;this._unbindDocumentClickHandler();_.defer(function(){$(document.body).bind("click",c._boundDocumentClickHandler)});c.$el.addClass("show-form").find("input")[0].focus()},_documentClickHandler:function(c){c.target.id!=="thread-subscribe-email"&&this.hideForm()},_unbindDocumentClickHandler:function(){$(document.body).unbind("click",this._boundDocumentClickHandler)},hideForm:function(){this._unbindDocumentClickHandler();this.$el.removeClass("show-form").find("input")[0].blur()},
subscribeKeypress:function(c){var a=this.$el.find("input");a.removeClass("alert error");if(c.key==="Esc"||c.keyCode===27)return void this.hideForm();if(!(c.key!=="Enter"&&c.keyCode!==13))c=c.target.value,d.validateEmail(c)?(this.hideForm(),this.thread.subscribe(!0,c)):a.addClass("alert error")}}),z=k.extend({initialize:function(c){_.extend(this,c)},render:function(){var c=DISQUS.renderBlock("userMenu",{user:this.session.toJSON(),thread:this.thread.toJSON(),logoutUrl:this.logoutUrl,feedbackUrl:this.getSurveyMonkeyUrl()});
this.updateDom(function(){this.$el.html(c)},this)},getSurveyMonkeyUrl:function(){var c=this.referrerUrl,a=this.session.user.id;return"https://www.surveymonkey.com/s/5RBPTTZ?c="+encodeURIComponent((a?[a,c]:[c]).join(";"))}}),w=new QueuedStorage(Modernizr.localstorage?window.localStorage:DISQUS.next.utils.hashStorage,5,"drafts.queue"),C=function(c){if(!c)throw Error("Cannot instantinate MediaStore without a valid storageKey!");this._storageKey=c;this._store=Modernizr.localstorage?window.localStorage:
DISQUS.next.utils.hashStorage};_.extend(C.prototype,{getItems:function(){var c=this._store.getItem(this._storageKey);return c&&o.parse(c)||{}},clear:function(){this._store.removeItem(this._storageKey)},getItem:function(c){return this.getItems()[c]},setItem:function(c,a){var b=this.getItems();b[c]=a;this._store.setItem(this._storageKey,o.stringify(b));return a},removeItem:function(c){var a=this.getItems();if(c in a)return delete a[c],this._store.setItem(this._storageKey,o.stringify(a)),!0;return!1}});
var u=k.extend({events:function(){var c={"click [data-action=attach]":"_attachMedia"};window.FormData&&_.extend(c,{dragover:"_dragOn",dragenter:"_dragOn",dragleave:"_dragOff",dragexit:"_dragOff",drop:"_drop"});return c},initialize:function(c){this.owner=c.owner;this.parent=c.parent;this.url=c.url},setElement:function(){var c=k.prototype.setElement.apply(this,arguments);this.$dragPlaceholder=this.$el.find("[data-role=drag-drop-placeholder]");this.$mediaSelector&&this.$mediaSelector.off();this.$mediaSelector=
this.$el.find("input[type=file][data-role=media-upload]");this.$mediaSelector.on("change",_.bind(this._selectorChange,this));return c},_toggleDragPlaceholder:_.throttle(function(c){c?this.$dragPlaceholder.show():this.$dragPlaceholder.hide()},50),_selectorChange:function(c){this.uploadMedia(c.target.files);if(m.switches.enabled("next_dragdrop_nag")&&c.target.files&&Modernizr.localstorage&&!window.localStorage.getItem("usedDragDrop"))this.owner.alert(n("Did you know you can drag and drop images too? Try it now: drag images below.")).on("dismiss",
function(){window.localStorage.setItem("usedDragDrop","1")})},_dragOn:function(c){c.stop();this._toggleDragPlaceholder(!0);this.owner.owner.$el.addClass("expanded")},_dragOff:function(c){c.stop();this._toggleDragPlaceholder(!1)},_drop:function(c){c.stop();window.localStorage.setItem("usedDragDrop","1");this._toggleDragPlaceholder(!1);this.uploadMedia(c.dataTransfer.files)},_attachMedia:function(c){c.stop();this.$mediaSelector[0].click()},_uploadMediaModern:function(c){for(var a=this,b=new FormData,
e=0,f=c[e];f;f=c[++e])f.type.match(/^image\//)&&b.append("attachment",f);b.append("json","true");this.parent&&b.append("id",this.parent.id);var g=d.makeCORSRequest("POST",this.url,function(){if(!(g.readyState!==void 0&&(g.readyState!==4||g.status!==200))){var c=o.parse(g.responseText);c.success?a.owner.addMedia(c.media):a.owner.alert(c.message,"error")}});g.withCredentials=!0;g.send(b)},_uploadMediaLegacy:function(){var c=this,a=document.createElement("iframe"),b=document.createElement("form"),d=
this.$mediaSelector[0];$(d).off();var e=$(d.cloneNode(!0));d.parentNode.replaceChild(e[0],d);e.on("change",_.bind(this._selectorChange,this));this.$mediaSelector=e;a.style.display="none";a.name="uploadFrame"+ +new Date;b.style.display="none";b.target=a.name;b.action=this.url;b.method="post";b.appendChild(a);b.appendChild(d);if(this.parent)a=document.createElement("input"),a.type="hidden",a.name="id",a.value=this.parent.id,b.appendChild(a);b.enctype="multipart/form-data";b.encoding="multipart/form-data";
var f=function(a){a=o.parse(a.data);a.name==="upload"&&($(b).remove(),$(window).off("message",f),a.data.success?c.owner.addMedia(a.data.media):c.owner.alert(a.data.message,"error"))};$(window).on("message",f);this.updateDom(function(){this.$el.append(b);b.submit()},this)},uploadMedia:function(c){this.uploadMedia=this["_uploadMedia"+(window.FormData?"Modern":"Legacy")];return this.uploadMedia(c)}}),q=k.extend({events:{"click [data-action=detach]":"_detachMedia","click ul[data-role=media-preview-list] [data-action=preview]":"_preview"},
initialize:function(c){this.alert=_.bind(c.owner.alert,c.owner);this.owner=c.owner;this.parent=c.parent;this.urls=c.urls;this.uploader=new u({owner:this,parent:this.parent,url:this.urls.add})},setElement:function(){var c=k.prototype.setElement.apply(this,arguments);this.$list=this.$el.find("ul[data-role=media-preview-list]");this.$expandedArea=this.$el.find("[data-role=media-preview-expanded]");this.expandedImg=this.$el.find("img[data-role=media-preview-expanded-image]")[0];return c},clear:function(){this.$el.addClass("empty");
this.$list.empty();this._hidePreview();this.owner.mediaStore&&this.owner.mediaStore.clear()},_$oldPreview:null,_preview:function(c){c.stop();var a=this.$expandedArea,b=this.expandedImg,d=c.currentTarget.href,e=$(c.currentTarget).closest("li");b.src!==d?this.updateDom(function(){b.src=d;a.removeClass("empty");e.addClass("active");this._$oldPreview&&this._$oldPreview.removeClass("active");this._$oldPreview=e},this):this._hidePreview()},_hidePreview:function(){this.updateDom(function(){this.$expandedArea.addClass("empty");
if(this._$oldPreview)this._$oldPreview.removeClass("active"),this._$oldPreview=null;this.expandedImg.src=null},this)},_detachMedia:function(c){c.stop();this.updateDom(function(){this.removeMedia($(c.target).closest("li"))},this)},addMedia:function(c){var a=$(DISQUS.renderBlock("mediaUpload",{media:c}));this.owner.mediaStore.setItem(c.location,c);a.attr("data-media-id",c.location);this.updateDom(function(){this.$list.append(a);this.$el.removeClass("empty")},this)},removeMedia:function(c){var a=this.owner.mediaStore.getItem(c.attr("data-media-id")),
b=this._$oldPreview;if(a){b&&c[0]===b[0]&&this._hidePreview();b={media:o.stringify(a)};if(this.parent)b.id=this.parent.id;(new Image).src=DISQUS.serialize(this.urls.remove,b,!0);this.owner.mediaStore.removeItem(a.location);this.updateDom(function(){c.remove();this.$list.children().length||this.$el.addClass("empty")},this)}}}),x=k.extend({events:{"click [name=author-register]":"expandRegister"},initialize:function(c){this.session=c.session;this.parent=c.parent;this.thread=c.thread;this.parentView=
c.parentView;this.thread.bind("change:id",function(){this.restoreDraft();if(this.thread.forum.get("settings").allowMedia)this.mediaStore=new C(this.storageKey("media"))},this);this.session.on("change:id change:audienceSyncVerified",this.redraw,this);this.parent&&(x.open[this.parent.cid]=this);this.textarea=Modernizr.contenteditable&&!DISQUS.browser.mobile&&(!window.opera||!window.opera.version)?new A({thread:this.thread}):new D;if(this.thread.forum.get("settings").allowMedia){if(c=this.storageKey("media"))this.mediaStore=
new C(c);this.mediaUploads=new q({owner:this,parent:this.parent,urls:{add:this.thread.get("uploadAdd"),remove:this.thread.get("uploadRemove")}})}},storageKey:function(c){if(!this.thread.id)return null;return[c||"drafts","thread",this.thread.id,"parent",this.parent?this.parent.id:0].join(":")},saveDraft:function(){this.storageKey()!==null&&w.setItem(this.storageKey(),o.stringify([this.textarea.get(),(new Date).getTime()]))},getDraft:function(){if(this.storageKey()===null)return null;var c=w.getItem(this.storageKey());
if(!c)return null;c=o.parse(c);if(c[1]+86400>(new Date).getTime())return c[0];w.removeItem(this.storageKey());return null},restoreDraft:function(){this.textarea.set(this.getDraft())},updateAvatar:function(){this.$el.find("[data-role=user-avatar]").attr("src",this.session.user.get("avatar").cache)},expandGuestForm:function(){this.$el.find("[data-role=guest-details]").addClass("expanded")},expandRegister:function(){this.$el.toggleClass("register")},redraw:function(){var c=this.$el.hasClass("expanded"),
a=this.el,b=this.$el.find("textarea").val();this.render();this.$el.find("textarea").val(b);c&&this.$el.addClass("expanded");$(a).parent().length!==0&&this.updateDom(function(){a.parentNode.replaceChild(this.el,a)},this)},render:function(){var c=this,a=c.getDraft()||"";this.setElement($(DISQUS.renderBlock("form",{message:a,parent:c.parent?c.parent.toJSON():null,user:c.session.toJSON(),forumName:c.thread.forum.get("name"),audienceSyncRequired:c.session.needsAudienceSyncAuth(c.thread.forum),apiKey:m.config&&
m.config.apiKey||"",mediaList:this.mediaStore?_.values(this.mediaStore.getItems()):[],allowAnonPost:c.thread.forum.get("settings").allowAnonPost,allowMedia:c.thread.forum.get("settings").allowMedia})));this.$el.find("form").bind("submit",_.bind(this.submitForm,this));var b=this.textarea;b.setElement(c.$el.find("textarea")[0]);b.render();b.bind("keychange",_.debounce(this.saveDraft,500),this);b.$el.bind("focus",function(){c.$el.addClass("expanded focus");_.delay(_.bind(c.resize,c),200)});b.$el.bind("blur",
function(){b.get()||c.$el.removeClass("focus")});this.mediaUploads&&(this.mediaUploads.setElement(this.$el.find("[data-role=media-preview]")[0]),this.mediaUploads.uploader.setElement(this.$el.find("[data-role=textarea]")[0]));c.$el.find("input[name=author-name]").bind("focus",function(){c.expandGuestForm()});c.typingStart();c.session.get("mustVerifyEmail")&&c._alertMustVerify()},resize:function(){this.textarea.resize()},focus:function(){this.textarea.focus()},clear:function(){var c=this;c.textarea.clear();
c.$el.removeClass("expanded");c.mediaUploads&&c.mediaUploads.clear();_.delay(function(){c.resize()},200);c.parent?c.$el.hide():c.$el.removeClass("expanded");this.storageKey()&&w.removeItem(this.storageKey())},restore:function(c){var a=this;a.textarea.set(c.get("raw_message"));_.delay(function(){a.resize()},200);a.parent&&a.$el.show()},_alertMustVerify:function(c){this.alert(DISQUS.interpolate(n("%(forumName)s requires you to %(verifyEmail)s before posting"),{forumName:this.thread.forum.get("name"),
verifyEmail:'<a href="#" data-action="verify-email">'+n("verify your email address")+"</a>"}),{safe:!0,type:c?"error":"warn"})},submitForm:function(c){function a(c){c=c.response;/Invalid email address/i.test(c)?b.alert(n("Invalid email address."),"error"):/Missing required argument\: \'email\'/i.test(c)?b.alert(n("Please enter an email address."),"error"):/Unable to create user/i.test(c)?b.alert(n("That email address is already registered with a Disqus account. Log in or enter another email."),"alert"):
b.alert(c,"error")}var b=this;c&&c.preventDefault&&c.preventDefault();if(this._alert)this._alert.remove(),this._alert=null;c=b.$el.find("input[name=author-register]");c=c.length&&c[0].checked;if(b.session.isAnonymous()&&c)return b.session.register({name:b.$el.find("input[name=author-name]").val(),email:b.$el.find("input[name=author-email]").val()},{error:a}),null;return b.createPost()},createPost:function(){var c=this,a={thread:c.thread.id,depth:c.parent?c.parent.get("depth")+1:0,parent:c.parent?
c.parent.id:null,raw_message:c.textarea.get()};c.session.isRegistered()?a.author_id=c.session.user.id:_.extend(a,{author_name:c.$el.find("input[name=author-name]").val(),author_email:c.$el.find("input[name=author-email]").val()});var b=new DISQUS.next.models.UniqueModel(DISQUS.next.models.Post);if(b.set(a,{error:function(a,b){c.alert(b,"error")}})){var d=null,e=function(a,e){if(e.code===19){if(d)return d.reload();d=new M;d.render();var i=m.getPostView(b.cid);i.el.parentNode.insertBefore(d.el,i.el);
d.start();d.bind("submitted",function(){b.save({recaptcha_challenge_field:d.getChallenge(),recaptcha_response_field:d.getResponse()},{success:function(){d.remove()}})})}else e.code===12&&/verify/.test(e.response)?c._alertMustVerify(!0):_.isString(e.response)&&c.alert(e.response,"error"),c.thread.posts.remove(b),c.restore(b),c.thread.incrementPostCount(-1)};b.on("error",e);b.on("sync",function ga(){c.thread.trigger("create",b);b.off("error",e);b.off("sync",ga)});b.save(a);b.author=c.session.isRegistered()?
c.session.user:new j.UniqueModel(j.User,{id:md5(a.author_email),name:a.author_name,email:a.author_email});c.thread.posts.add(b,{created:!0});c.clear();c.trigger("submitted");c.thread.incrementPostCount(1);m.trigger("uiAction:createPost",b);return b}},remove:function(){this.updateDom(function(){this.$el.remove()},this);this.parent&&(delete x.open[this.parent.cid],this.typingStop())},toggle:function(){this.$el.toggle();this.isOpen()?this.typingStart():this.typingStop()},isOpen:function(){return this.el.style.display!==
"none"},typingStart:function(){var c=this;c.parent&&l.getInstance().isRealtimeEnabled()&&_.delay(function(){var a=DISQUS.urls.realertime+"/api/2/typing/",b;d.attempt(function(){b=d.makeCORSRequest("POST",a)});if(b===null)return void DISQUS.log("CORS is not supported by this browser.");var e=o.stringify({typing:!0,forum_url:c.thread.get("forum"),thread_id:c.thread.get("id"),user_id:c.session.user.id||0,parent_post_id:c.parent.get("id")});d.attempt(function(){b.send(e)})},500)},typingStop:function(){var c=
this;c.parent&&l.getInstance().isRealtimeEnabled()&&_.delay(function(){var a=DISQUS.urls.realertime+"/api/2/typing/",b;d.attempt(function(){b=d.makeCORSRequest("POST",a)});if(b===null)return void DISQUS.log("CORS is not supported by this browser.");var e=o.stringify({typing:!1,forum_url:c.thread.get("forum"),thread_id:c.thread.get("id"),user_id:c.session.user.id||0,parent_post_id:c.parent.get("id")});d.attempt(function(){b.send(e)})},500)}});_.extend(x.prototype,r);x.open=x.open||{};var L=k.extend({initialize:function(c){this.post=
c.post;this.textarea=new D},render:function(){this.setElement($(DISQUS.renderBlock("edit",{post:this.post.toJSON()})));this.$el.find("form").bind("submit",_.bind(this.submitForm,this));var c=this.textarea;c.setElement(this.$el.find("textarea")[0]);c.render()},resize:function(){this.textarea.resize()},submitForm:function(c){c&&c.preventDefault()&&c.preventDefault();var c={raw_message:this.textarea.get()},a=this.post.validate(c);if(a!==void 0)return alert(a);this.trigger("submitted");this.post.save(c,
{success:function(){}})},remove:function(){this.updateDom(function(){this.$el.remove()},this)}}),G=k.extend({initialize:function(c){this.MAX_POST_HEIGHT=374;this.thread=c.thread;this.session=c.session;this.created=!!c.created;this.model.bind("destroy",this.removeAsDeleted,this);this.model.bind("spam",this.removeAsDeleted,this);this.model.bind("change:message",this.stopLoading,this);this.model.bind("change:points",this.updatePoints,this);this.model.bind("change:userScore",this.updateVotes,this);this.model.usersTyping.bind("add remove reset",
this.updateTypingCount,this);this.session.on("change:id",this.updateEditHide,this);this.session.on("change:id",this.updateFooter,this);this.session.on("change:id",this.updateMenu,this);this.session.on("change:id",this.updateVotes,this);this.model.bind("change",function(){var c=this.model.changedAttributes();(c.id||c.message)&&this.redraw()},this);this.edit=this.reply=null;this.parent=c.parent;this.trackPosition=!1;l.getInstance().on("domReflow",function(){if(this.trackPosition){var c=this.contentNode;
this.offset=c.offset();this.dim=c.dim()}else this.offset={top:-1,height:-1},this.dim={height:-1,width:-1}},this);this.isCollapseAllowed=!0},updateTypingCount:function(){this.typingUserView&&this.typingUserView.render()},stopLoading:function(){this.contentNode.find(".loading").removeClass("loading")},updateRelativeTime:function(){this.contentNode.find("[data-role=relative-time]").text(this.model.getRelativeCreatedAt())},updateVotes:function(){var c=this.model,a=this.contentNode.find("[data-role=voting]"),
b=DISQUS.renderBlock("postVotes",{session:{id:this.session.user.id},post:{userScore:c.get("userScore"),points:c.get("points"),likes:c.get("likes"),dislikes:c.get("dislikes")}});this.updateDom(function(){a.html(b)})},updateEditHide:function(){var c=this.contentNode.find("[data-role=edit-hide]"),a=DISQUS.renderBlock("postEditHide",{post:{author:{id:this.model.author.id}},session:{id:this.session.user.id}});this.updateDom(function(){c.html(a)})},updateFooter:function(){var c=this.contentNode.find("footer"),
a=DISQUS.renderBlock("postFooter",{post:this.model.toJSON(),session:this.session.toJSON(),thread:this.thread.toJSON()});this.updateDom(function(){c.html(a)})},updateMenu:function(){var c=this.contentNode.find("[data-role=menu]"),a=DISQUS.renderBlock("postMenu",{session:this.session.toJSON(),post:this.model.toJSON()});this.updateDom(function(){c.html(a)})},updatePoints:function(c){var a=function(c){_.delay(function(){c.addClass("update");_.delay(function(){c.removeClass("update")},1E3)},500)};this.contentNode.find("[data-role=likes], [data-role=dislikes]").each(function(b){var b=
$(b),d=b.html(),e=c.get(b.attr("data-role")).toString();d!==e&&(b.removeClass("count-"+e),b.removeClass("count-"+d),b.html(e),a(b))})},getMessageContainer:function(){if(!this.messageContainer||!this.messageContainer.length)this.messageContainer=this.contentNode.find("[data-role=message-container]");return this.messageContainer},getMoreButton:function(){if(!this.seeMoreButton||!this.seeMoreButton.length)this.seeMoreButton=this.contentNode.find("[data-action=post-expand]");return this.seeMoreButton},
getShadowEl:function(){if(!this.shadowNode||!this.shadowNode.length)this.shadowNode=this.contentNode.find("[data-role=message-shadow]");return this.shadowNode},manageMessageHeight:function(){var c=this.messageNode,a=this.MAX_POST_HEIGHT;l.getInstance().switches.enabled("next_comments_truncation_enabled")&&this.isCollapseAllowed&&(c&&c.length&&c.height()>a*1.5?this.collapseMessage():this.expandMessage(!0))},collapseMessage:function(){var c=this.getMessageContainer(),a=this.MAX_POST_HEIGHT;c&&c.length&&
!c.hasClass("post-message-collapse")&&(this.updateDom(function(){c.addClass("post-message-collapse");c.height(a)}),this.addMoreButton())},expandMessage:function(c){if(this.messageContainer&&this.messageContainer.length){var a=this.getMessageContainer();this.updateDom(function(){a.removeClass("post-message-collapse");a.css("height",null)});this.removeMoreButton();if(c!==!0)this.isCollapseAllowed=!1}},addMoreButton:function(){var c=this.getMoreButton(),a=this.getShadowEl();this.updateDom(function(){a.removeClass("hidden");
c.removeClass("hidden")})},removeMoreButton:function(){var c=this.getMoreButton(),a=this.getShadowEl();this.updateDom(function(){c.addClass("hidden");a.addClass("hidden")})},markSeen:function(){function c(d){var e,f;if(!d)return!1;e=a.offset.top+d.frameOffset.top;f=(f=e>d.pageOffset)&&e+a.dim.height<=d.pageOffset+d.height;if(!f)return!1;a.contentNode.addClass("seen");_.delay(function(){a.contentNode.removeClass("seen");a.contentNode.removeClass("new")},1E4);a.trackPosition=!1;b.off("scroll",c);return!0}
var a=this,b=l.getInstance();if(!c(b.position))b.on("scroll",c,a);b.off("domReflow",a.markSeen)},render:function(){var c=this,a=c.parent&&c.parent.model;c.setElement($(DISQUS.renderBlock("post",{post:c.model.toJSON(),session:c.session.toJSON(),thread:c.thread.toJSON(),loading:!c.model.id,created:c.created,parentAuthorName:a?a.author.get("name"):null})));c.contentNode=c.$el.find("[data-role=post-content]");c.childrenNode=c.$el.find("[data-role=children]");c.messageNode=c.contentNode.find("[data-role=message]");
this.highlightSyntax();if(c.model.get("isRealtime"))l.getInstance().switches.enabled("next_realtime_anim_disabled")?c.contentNode.removeClass("new"):(c.trackPosition=!0,m.on("domReflow",c.markSeen,c));m.on("domReflow",_.once(function(){var a=c.$el.find("[data-role=realtime-notification:"+c.model.id+"] .realtime-replies");c.manageMessageHeight();c.typingUserView=new U({parentView:c,model:c.model,el:a})}));c.processMentions();c.bindDomEvents();if(a&&!a.get("isDeleted"))c.contextCard=K.create({post:this.parent.model,
targetElement:this.$el.find("[data-role=parent-link]")})},highlightSyntax:function(){var c=this.contentNode.find("pre code");c.length&&c.each(function(c){d.syntaxHighlighter.highlight(c)})},redraw:function(){var c=this.$el;if(!c)throw Error("Old child not found on PostView.redraw");var a=this.childrenNode.children();this.render();this.updateDom(function(){c[0].parentNode.replaceChild(this.el,c[0]);this.childrenNode.append(a)},this)},processMentions:function(){this.contentNode.find("[data-dsq-mention]").each(function(){$(this).addClass("mention")})},
attachChild:function(c){var a=c.model;!a.id||a.get("isImmediateReply")?this.childrenNode.prepend(c.el):this.childrenNode.append(c.el)},toggleReply:function(){if(this.reply)return void this.reply.toggle();this.reply=new x({parentView:this,parent:this.model,thread:this.thread,session:this.options.session});this.reply.bind("submitted",function(){this.reply.$el.hide()},this);this.drawReply()},drawReply:function(){this.reply&&(this.reply.render(),this.updateDom(function(){var c=this.childrenNode[0];c.insertBefore(this.reply.el,
c.firstChild);this.reply.focus()},this))},toggleEdit:function(){this.edit?(this.edit.remove(),this.edit=null,this.contentNode.find("[data-role=message]").show()):(this.edit=new L({post:this.model}),this.edit.render(),this.edit.bind("submitted",this.toggleEdit,this),this.expandMessage(!0),this.updateDom(function(){var c=this.contentNode.find("[data-role=message]");c[0].parentNode.insertBefore(this.edit.el,c[0]);c.hide();this.edit.resize();(c=l.getInstance())&&c.scrollToPost(this.model.id)},this))},
removeAsDeleted:function(){this.redraw()},bindDomEvents:function(){var c=this;c.delegateActions(c.contentNode,{upvote:function(){c.handleVote(1)},downvote:function(){c.handleVote(-1)},reply:"handleReply",flag:"handleFlag",edit:"handleEdit","delete":"handleDelete",spam:"handleSpam",blacklist:"handleBlacklist",collapse:"handleCollapse",reveal:"handleReveal","share:twitter":"_onShare","share:facebook":"_onShare","post-expand":f(c.expandMessage)});var a=c.$el.find(".hovercard");if(a.length)c.profileCard=
F.create({session:c.session,user:c.model.author,targetElement:a})},_onShare:function(c){if(c=g(c.target,"share"))m.trigger("uiAction:postShare",c),this.share(c)},_shareUrl:function(){return this.thread.url()+"#comment-"+this.model.id},handleBlacklist:function(){if(!this.blacklist){var c=this.blacklist=new V({model:this.model});c.render();c.on("success cancel",function(){this.blacklist.remove();this.blacklist=null},this);this.updateDom(function(){this.contentNode.find("[data-role=blacklist-form]").first().append(c.el)},
this)}},handleCollapse:function(){this.updateDom(function(){this.$el.toggleClass("collapsed")},this)},handleVote:function(c){c===1?m.trigger("uiAction:postUpvote"):c===-1&&m.trigger("uiAction:postDownvote");var a=this.model.get("userScore")===c;this.model.vote(a?0:c);var b=this.contentNode.find("[data-role=voting]");b.removeClass("upvoted").removeClass("downvoted");a||(c>0?b.addClass("upvoted"):c<0&&b.addClass("downvoted"))},remove:function(){this.model.off(null,null,this);this.session.off(null,null,
this);Backbone.View.prototype.remove.call(this)},handleReply:function(){this.toggleReply()},handleFlag:function(){window.confirm("Are you sure you want to flag this comment?")&&this.model.report()},handleEdit:function(){this.toggleEdit()},handleDelete:function(){this.model.destroy()},handleSpam:function(){this.model.spam()},handleReveal:function(){this.model.set("isMinimized",!1);this.redraw()}});_.extend(G.prototype,p);var M=k.extend({render:function(){var c=this;c.setElement($(DISQUS.renderBlock("captcha")));
c.$el.bind("submit",function(a){a.preventDefault();c.trigger("submitted")})},start:function(){function c(){a.updateDom(function(){Recaptcha.create("6LdKMrwSAAAAAPPLVhQE9LPRW4LUSZb810_iaa8u",a.el,{theme:"custom",custom_theme_widget:"recaptcha_widget"});a.$el.show()})}var a=this;typeof Recaptcha==="undefined"?DISQUS.require("//www.google.com/recaptcha/api/js/recaptcha_ajax.js",{},!1,c):c()},getChallenge:function(){return Recaptcha.get_challenge()},getResponse:function(){return Recaptcha.get_response()},
reload:function(){Recaptcha.reload()}}),H=k.extend({initialize:function(c){this.session=c.session;this.showZero=c.showZero||!1;this.max=c.max;this.session.on("change:notificationCount",this.render,this)},render:function(){var c=this.session.get("notificationCount")||0;this.max&&(c=Math.min(c,this.max));this.$el.html("<span>"+c+"</span>");c>0||this.showZero?this.$el.show():this.$el.hide();return this}}),E=Backbone.View.extend({__type__:"QueuedPostView",getDirection:function(c){var a=c.pageOffset,b=
this.offset.top+c.frameOffset.top;if(b+this.dim.height<a)return 1;if(b>a+c.height)return-1;return 0},setCount:function(c){this.options.count=c},bindDrain:function(){var c=_.bind(this.drainHandler,this);if(!this.clickEvent)this.$el.attr("data-action")=="load-queued-posts"?this.$el.bind("click",c):this.$el.delegate("[data-action=load-queued-posts]","click",c),this.clickEvent=!0},render:function(){var c=this;if(c.options.count===0)return void c.$el.hide();c.$el.html(DISQUS.renderBlock("realtimeCommentNotification",
{comments:c.options.count}));c.bindDrain();l.getInstance().on("domReflow",_.throttle(function(){if(c.options.count!==0)this.offset=c.$el.offset(),this.dim=c.$el.dim()},400),this);c.$el.show()},drainHandler:function(){this.model.queue.drain();this.setCount(this.model.queue.length);this.render()}}),N=E.extend({getDirection:function(c){this.offset=this.options.postView.offset;this.dim=this.options.postView.dim;c=E.prototype.getDirection.call(this,c);delete this.offset;delete this.dim;return c},render:function(){var c=
this,a=c.options.postView;DISQUS.log("Model:",c.model.id);c.options.count===0?(c.$el.hide(),a.trackPosition=!1):(a.trackPosition=!0,c.$el.html(DISQUS.renderBlock("realtimeReplyNotification",{replies:c.options.count})),c.bindDrain(),c.$el.show(),_.delay(function(){c.$el.addClass("reveal")},13))},drainHandler:function(){var c=this.model.id,a=this.options.postView,b=this.options.thread.queue;b.drain(c);this.setCount(b.counters.replies[c]);a.trackPosition=!1;this.render()}}),U=Backbone.View.extend({render:function(){var c=
this.model.usersTyping.count(),a=this.options.parentView.reply;a&&a.isOpen()&&(c-=1);if(c<=0)return void this.$el.hide();c==1?this.$el.html("One other user is typing&hellip;"):this.$el.html(c+" other users are typing&hellip;");this.$el.show()}}),W=k.extend({tagName:"ul",className:"loading",initialize:function(c){this.collection.bind("reset",this.render,this);this.session=c.session},render:function(){this.updateDom(function(){this.$el.removeClass("loading");this.$el.empty();this.collection.each(function(c){this.$el.append(DISQUS.renderBlock("activityItem",
{activity:c.toJSON(),session:this.session?this.session.toJSON():null}))},this);this.trigger("render")},this);return this}}),R=k.extend({events:{"click [data-action=network]":"showNetwork","click [data-action=notifications]":"showNotifications"},initialize:function(c){this.network=new X;this.notifications=new Y({notifications:c.session.notifications});this.notificationCount=new H({session:c.session,showZero:!0});this._views={network:this.network,notifications:this.notifications};this.network.on("render:activity",
_.bind(this.trigger,this,"render:all"))},render:function(){this.updateDom(function(){this.$el.html(DISQUS.renderBlock("dashboard"))},this);this._tabs={network:this.$el.find("[data-role=network-tab]"),notifications:this.$el.find("[data-role=notifications-tab]")};this.network.setElement(this.$el.find("[data-role=network]"));this.notifications.setElement(this.$el.find("[data-role=notifications]"));this.notificationCount.setElement(this.$el.find("[data-role=notification-count]"));this.network.render();
this.notifications.render();this.notificationCount.render()},show:function(){this.setActiveTab("network")},setActiveTab:function(c){var a=l.getInstance();a.freeze(!0);_.chain(this._tabs).invoke("removeClass","active");this._tabs[c].addClass("active");_.chain(this._views).pluck("$el").invoke("hide");var b=this._views[c];this.updateDom(function(){b.$el.show();a.freeze(!1)},this);b.show&&b.show()},showNetwork:f(function(){this.setActiveTab("network")}),showNotifications:f(function(){this.setActiveTab("notifications")})}),
Z=k.extend({events:{"click [data-action=more]":f(function(){this.trigger("fire")})},setBusy:function(){this.$el.find("[data-action=more]").addClass("busy").removeAttr("disabled")},setReady:function(){this.$el.find("[data-action=more]").removeClass("busy").removeAttr("disabled");this.updateDom(function(){var c=this.collection.cursor;c&&c.hasNext?this.$el.show():this.$el.hide()},this)}}),Y=k.extend({initialize:function(c){this.notifications=c.notifications;this.notifications.on("reset",this.resetNotifications,
this);this.notifications.on("add:many",this.addNotifications,this);this.notifications.on("reset add:many",this.markNotificationsAsRead,this);this._fetched=!1;this.moreButton=new Z({collection:this.notifications});this.moreButton.on("fire",this.loadMore,this)},render:function(){return this.renderLayout()},renderLayout:function(){this.updateDom(function(){this.$el.html(DISQUS.renderBlock("notifications"));this.moreButton.setElement(this.$el.find("[data-role=more-notifications]"));this.$el.addClass("loading")},
this);return this},resetNotifications:function(c){var a=this.$el.find("[data-role=no-notifications]");a.hide();this.$el.removeClass("loading");c.size()===0?a.show():(a.hide(),this.addNotifications.apply(this,arguments))},addNotifications:_.decorate(Backbone.collectionAddNormalizer(h.NotificationCollection,j.Notification),function(a){var b=_.map(a,function(a){return $(DISQUS.renderBlock("notification",{notification:a.toJSON()}))[0]});this.updateDom(function(){this.$el.find("[data-role=entries]").append(b)},
this);this.moreButton.setReady();this.notifications.markRead();return this}),show:function(){if(!this._fetched)this.notifications.fetch(),this._fetched=!0},loadMore:function(){this.moreButton.setBusy();this.notifications.more()}}),X=k.extend({initialize:function(){this.posts=new h.PostActivityCollection;this.posts.on("reset",this.resetActivity,this);this.posts.on("add:many",this.addActivity,this);this._fetched=!1;this.moreButton=new Z({collection:this.posts});this.moreButton.on("fire",this.loadMore,
this)},render:function(){return this.renderLayout()},renderLayout:function(){this.updateDom(function(){this.$el.html(DISQUS.renderBlock("networkActivity"));this.moreButton.setElement(this.$el.find("[data-role=more-activity]"));this.$el.addClass("loading")},this);return this},resetActivity:function(a){var b=this.$el.find("[data-role=no-activity]");b.hide();this.$el.removeClass("loading");a.size()===0?b.show():(b.hide(),this.addActivity.apply(this,arguments))},addActivity:_.decorate(Backbone.collectionAddNormalizer(h.PostActivityCollection,
j.Post),function(a){var b=new Backbone.Collection;_.each(a,function(a){var c=b.get(a.get("thread").id)||new j.Thread(_.extend(a.get("thread"),{forum:a.get("forum")}));c.posts.add(a);b.add(c)});var d=b.map(function(a){var c=$(DISQUS.renderBlock("networkActivityThreadEntry",{thread:a.toJSON()})),a=a.posts.map(function(a){return $(DISQUS.renderBlock("networkActivityPostEntry",{post:a.toJSON()}))[0]});c.find("[data-role=posts]").append(a);return c[0]});this.updateDom(function(){this.$el.find("[data-role=entries]").append(d);
this.trigger("render:activity")},this);this.moreButton.setReady();return this}),show:function(){if(!this._fetched)this.posts.fetch(),this._fetched=!0},loadMore:function(){this.moreButton.setBusy();this.posts.more()}}),aa=k.extend({tagName:"ol",className:"loading",initialize:function(){this.collection.bind("reset",function(){this.updateDom(this.render,this)},this)},render:function(){this.updateDom(function(){this.$el.removeClass("loading");this.$el.empty();this.collection.each(function(a){var b=DISQUS.assureOffset(a.get("createdAt"));
this.$el.append(DISQUS.renderBlock("topThread",{id:a.id,title:a.get("title"),url:a.get("link"),numPosts:a.get("postsInInterval"),numLikes:a.get("likes"),timeAgo:moment(b,DISQUS.ISO_8601).fromNow()}))},this);this.trigger("render")},this);this.attachPosts();return this},attachPosts:function(){this.collection.each(function(a){this.renderPost(a)},this)},renderPost:function(a){var b=a.get("topPost");if(b){var d=_.escape(_.strip(b.message)),d=_.truncate(d,160,"&hellip;"),e=DISQUS.renderBlock("topThreadPost",
{message:d,author:b.author});this.updateDom(function(){this.$el.find("[data-role=thread-"+a.id+"] [data-role=top-thread-post]").html(e)},this)}}}),ba=k.extend({tagName:"ol",className:"loading",initialize:function(){this.collection.bind("reset",function(){m.thread.users.add(this.collection.models,{merge:!0});this.updateDom(this.render,this)},this)},render:function(){this.updateDom(function(){this.$el.removeClass("loading");this.$el.empty();this.collection.each(function(a){this.$el.append(DISQUS.renderBlock("topUser",
{user:a.toJSON()}))},this);this.trigger("render")},this);return this}}),S=Backbone.View.extend({initialize:function(a){var b=this;b.forum=a.forum;b.topThreads=new aa({id:"top-threads",collection:new h.TopThreadCollection(null,{forum:b.forum.id,limit:10})});b.topUsers=new ba({id:"top-users",collection:new h.TopUserCollection(null,{forum:b.forum.id,limit:20,discardLowRep:m.switches.enabled("next_discard_low_rep")})});Backbone.when([b.topUsers,"render"],[b.topThreads,"render"]).then(function(){b.isRendered=
!0;b.trigger("render:all")});b.fetched=!1;b.render()},render:function(){this.$el.html(DISQUS.renderBlock("community",{forum:this.forum.toJSON()}));this.$el.find("[data-role=top-threads]").append(this.topThreads.el);this.$el.find("[data-role=top-users]").append(this.topUsers.el);return this},show:function(){if(!this.fetched)this.topThreads.collection.fetch(),this.topUsers.collection.fetch(),this.fetched=!0}}),ja=k.extend({initialize:function(a){this.$el.addClass("loading");this.thread=a.thread;this.session=
a.session;this.collection.on("add reset",this.render,this)},render:function(a,b,d){var e=this,f=(d&&d.index!=null?[e.collection.at(d.index)]:e.collection).map(function(a){a=new ca({model:a,thread:e.thread,session:e.session});a.render();return a.el});e.updateDom(function(){e.$el.removeClass("loading");e.$el.append(f);e.isRendered=!0;e.trigger("render:all")})},show:function(){this.collection.length>0||this.collection.fetch()}}),p={toggleFollow:function(a){a.preventDefault();this.user.get("isFollowing")?
(this.user.unfollow(),$(a.target).removeClass("active")):($(a.target).addClass("active"),this.user.follow(),m.trigger("uiAction:followUser"))}},J=Backbone.View.extend({events:{"click [data-action=close]":"close","click [data-action=toggleFollow]":"toggleFollow"},initialize:function(a){var b=this;b.user=a.user;b.session=a.session;b.user.get("numFollowers")===null&&b.user.fetch({success:function(){b.updateStats()}});b.user.on("change",b.updateStats,b);b.user.on("change:connections",b.updateConnections,
b);b.user.on("change:isFollowing",b.updateActions,b);b.activity=new W({id:"activity",collection:new h.ActivityCollection(null,{user:b.user,include:"user"}),session:b.session});b.activity.on("render",function(){b.isRendered=!0;b.trigger("render:all")});b.render()},updateStats:function(){this.$el.find("[data-role=profile-stats]").html(DISQUS.renderBlock("profileStats",{user:this.user.toJSON()}))},updateActions:function(){this.$el.find("[data-role=actions]").html(DISQUS.renderBlock("profileActions",
{user:this.user.toJSON(),sessionId:this.session.user.id}))},updateConnections:function(){DISQUS.blocks.profileConnections&&this.$el.find("[data-role=connections]").html(DISQUS.renderBlock("profileConnections",{user:this.user.toJSON()}))},close:f(function(){this.trigger("close")}),render:function(){this.$el.empty();this.$el.append(DISQUS.renderBlock("profile",{user:this.user.toJSON(),sessionId:this.session.user.id}));this.$el.find("[data-role=user-activity]").append(this.activity.el)},show:function(){this.activity.collection.fetch()}});
_.extend(J.prototype,p);var t=k.extend({initialize:function(){this._id=_.uniqueId();this._hoverState="out";this._leaveTimeout=this._enterTimeout=null;t.open={}},bindEvents:function(){var a=this;a.$el.bind("mouseover",function(){a.enter()});a.$el.bind("mouseout",function(){a.leave()})},target:function(a){var b=this;a.bind("mouseover",function(){b.enter(a)});a.bind("mouseout",function(){b.leave()})},enter:function(a){var b=this;if(a)this.$target=a;b._leaveTimeout&&clearTimeout(b._leaveTimeout);if(b._hoverState!==
"in")b._hoverState="in",b._enterTimeout=_.delay(function(){b._hoverState==="in"&&b.show();b._enterTimeout=null},t.DELAY_ENTER),t.open[this.uid]=this},leave:function(){var a=this;a._enterTimeout&&clearTimeout(a._enterTimeout);if(a._hoverState!=="out")a._hoverState="out",a._leaveTimeout=_.delay(function(){a._hoverState==="out"&&a.hide();a._leaveTimeout=null},t.DELAY_LEAVE),t.open[this.uid]&&delete t.open[this.uid]},show:function(){this.$target.append(this.el)},hide:function(){this.$el.remove()}},{open:{},
instances:{},DELAY_ENTER:350,DELAY_LEAVE:175,exitAll:function(){_.invoke(t.open,"leave")},create:function(a,b,d,e){var f=t.instances[d];f||(t.instances[d]=f={});d=f[a];d||(d=new e(b),f[a]=d,d.render());d.target(b.targetElement);return d}});(function(){$(document).bind("mouseout",_.debounce(function(a){a=a.relatedTarget||a.toElement;(!a||a.nodeName==="HTML")&&t.exitAll()}),10)})();var F=t.extend({events:{"click [data-action=toggleFollow]":"toggleFollow"},initialize:function(a){var b=this;t.prototype.initialize.call(b,
a);b.session=a.session;b.user=a.user;b.user.on("change:numPosts change:numLikesReceived",_.debounce(function(){b.updateCounters()}));b.user.on("change:isFollowing",function(){b.updateActions()});b.session.on("change:id",function(){b.render()})},render:function(){var a=this.user.toJSON();if(a.about)a.about=_.truncate(a.about,80,"...");this.setElement($(DISQUS.renderBlock("hovercard",{user:a,sessionId:this.session.user.id})));this.bindEvents()},updateCounters:function(){var a=this.$el.find("[data-role=counters]");
this.updateDom(function(){a.html(DISQUS.renderBlock("hovercardCounters",{user:this.user.toJSON(),sessionId:this.session.user.id}))},this)},updateActions:function(){var a=this.$el.find("[data-role=actions]");this.updateDom(function(){a.html(DISQUS.renderBlock("hovercardActions",{user:this.user.toJSON(),sessionId:this.session.user.id}))},this)},show:function(){this.user.get("numLikesReceived")===null&&this.user.fetch();t.prototype.show.call(this)}},{create:function(a){return t.create(a.user.id,a,"ProfileCard",
F)}});_.extend(F.prototype,p);var K=t.extend({initialize:function(a){t.prototype.initialize.call(this,a);this.post=a.post},render:function(){var a=this.post.toJSON();a.excerpt=_.truncate(_.escape(_.strip(a.message),40,"..."));this.setElement($(DISQUS.renderBlock("contextCard",{post:a})));this.bindEvents()}},{create:function(a){if(DISQUS.blocks.contextCard)return t.create(a.post.id,a,"ContextCard",K)}}),ca=k.extend({events:{"click [data-action=remove]":"destroyReaction"},initialize:function(a){this.thread=
a.thread;this.session=a.session;this.session.on("change:id",this.renderMenu,this)},render:function(){this.setElement($(DISQUS.renderBlock("reaction",{reaction:this.model.toJSON(),thread:this.thread.toJSON()})))},renderMenu:function(){var a=this.$el.find("[data-role=menu]"),b=DISQUS.renderBlock("reactionMenu",{thread:this.session.toJSON().thread});this.updateDom(function(){a.html(b)},this)},destroyReaction:function(a){a&&a.preventDefault&&a.preventDefault();this.model.destroy();this.updateDom(function(){this.remove()},
this)}}),O=k.extend({events:{"click [data-action=dismiss]":"dismiss"},initialize:function(a){_.extend(this,a)},render:function(){this.setElement($(DISQUS.renderBlock("alert",{message:this.message,type:this.type,safe:this.safe})));return this},dismiss:function(a){a&&a.preventDefault&&a.preventDefault();this.remove();this.trigger("dismiss")}}),V=k.extend({events:{"click [data-action=cancel]":"cancel"},initialize:function(){var a=this;a.loading=!1;if(!a.model.get("ipAddress"))a.loading=!0,a.model.on("change:ipAddress",
function s(){a.model.off("change:ipAddress",s);a.loading=!1;a.redraw()}),a.model.fetch()},render:function(){var a=this;a.setElement($(DISQUS.renderBlock("blacklist",{loading:this.loading,post:a.model.toJSON()})));a.$el.bind("submit",function(b){b&&b.preventDefault()&&b.preventDefault();a.submit()});return a},redraw:function(){var a=this.el.parentNode;a&&(this.render(),this.updateDom(function(){$(a).empty().append(this.el)},this))},cancel:function(a){a&&a.preventDefault()&&a.preventDefault();this.trigger("cancel")},
submit:function(){var a={},b=this;b.$el.find("input").each(function(){if(this.checked)a[this.name]=this.value});if(!_.isEmpty(a))a.forum=b.model.get("forum"),DISQUS.api.call("blacklists/add.json",{method:"POST",data:a,success:function(){b.trigger("success")}})}}),D=k.extend({events:{keyup:"handleKeychange",paste:"handleKeychange"},render:function(){this.el.tagName==="TEXTAREA"&&this.$el.autoresize({maxHeight:350});this.$el.bind("resize",_.debounce(_.bind(this.updateDom,this,function(){}),300));return this},
resize:function(){this.$el.trigger("paste")},get:function(){return this.$el.val()},set:function(a){this.$el.val(a)},clear:function(){this.set("")},focus:function(){this.el.focus()},handleKeychange:function(){this.trigger("keychange")}}),A=D.extend({events:{keyup:"handleKeychange",paste:"handleKeychange"},initialize:function(a){a=a||{};this.thread=a.thread;this.mentionsCache=new h.UserCollection;this.suggestions=new da({thread:a.thread,mentions:this.mentionsCache});this.placeholder="";this.suggestions.on("select",
this.insertMention,this);this.reset()},reset:function(){this.anchorOffset=this.anchorNode=null;this.suggestions.clear()},handleKeychange:function(){this.trigger("keychange");this.$el.trigger("resize")},render:function(){var a=this.el.getAttribute("placeholder"),b=this.el.value,d=document.createElement("div");_.extend(d,{className:"textarea",contentEditable:!0,tabIndex:this.el.tabIndex});d.setAttribute("role","textbox");d.setAttribute("aria-multiline","true");d.style.overflow="auto";d.style.maxHeight=
"350px";var e=this.el.parentNode;e.replaceChild(d,this.el);this.setElement(d);this.bindKeyEvents();e.appendChild(this.suggestions.el);this.content=new Editable(this.el,!0);b&&this.set(b);D.prototype.render.call(this);if(a)this.placeholder='<span class="placeholder">'+a+"</span>",this.content.text()||this.$el.html(this.placeholder),this.$el.bind("focus focusin",_.debounce(_.bind(function(){this.isPlaceholder()&&this.set("");this.el.focus()},this)),50),this.$el.bind("blur",_.bind(function(){this.content.text()===
""&&this.setPlaceholder()},this));return this},isPlaceholder:function(){return this.$el.find(".placeholder").length!==0},setPlaceholder:function(){this.$el.html(this.placeholder)},bindKeyEvents:function(){this.$el.bind("keydown",_.bind(function(a){switch(a.keyCode){case 9:this.suggestions.active&&(this.suggestions.select(),a.preventDefault(),a.stopPropagation());break;case 10:case 13:case 38:case 40:this.suggestions.active&&(a.preventDefault(),a.stopPropagation())}},this));var a=_.throttle(_.bind(this.suggest,
this),500);this.$el.bind("keyup",_.bind(function(b){b.preventDefault();b.stopPropagation();this.checkExistingMentions();switch(b.keyCode){case 50:if(!b.shiftKey)break;this.start(b);break;case 10:case 13:this.suggestions.select();break;case 27:this.reset(b);break;case 38:this.suggestions.move("up");break;case 40:this.suggestions.move("down");break;default:a(b)}},this))},start:function(){this.reset();this.suggest()},suggest:function(){this.suggestions.suggest(this.parseSearchTerms())},insertMention:function(a){var b=
this.thread.users.getByCid(a);this.selectSearchString(b);this.mentionsCache.getByCid(a)||this.mentionsCache.add(b);this.content.insertHTML(A.getMentionHtml(b));a=this.$el.find("span[data-cid]");_.each(a,function(a){if(a.contentEditable!==!1)a.contentEditable=!1})},selectSearchString:function(){this.content.selectNodeText(this.anchorNode,this.anchorOffset-1,this.anchorOffset+Editable.normalizeSpace(this.anchorNode.nodeValue.slice(this.anchorOffset)).toLowerCase().length)},get:function(){var a=this,
b=A.isMention;if(this.isPlaceholder())return"";return this.content.text(function(d){return b(d,!0)?a.mentionToText(d):null})},set:function(a){this.content.setText(a);this.resize()},clear:function(){D.prototype.clear.call(this);this.setPlaceholder();_.defer(function(a){a.updateDom(function(){a.el.blur();a.$el.trigger("blur")})},this)},parseSearchTerms:function(){var a=this.content.selectedTextNode(),b=a?a.nodeValue:"",d=Editable.normalizeSpace;if(b){var e=this.content.selectedTextNodeOffset(a),f=Editable.normalizeSpace(b.slice(0,
e).split("").reverse().join("")).indexOf("@");if(f===-1)return null;this.anchorNode=a;this.anchorOffset=e-f;if(a=d(b.slice(this.anchorOffset-1,e)).match(A.MENTIONS_RE))return a[0].slice(1).split(" ");if(f===0)return[""]}},checkExistingMentions:function(){var a=Editable.normalizeSpace,b=this.$el.find("span"),b=_.filter(b,A.isMention),d=this.mentionsCache,e={};_.each(b,function(b){var f=$(b).attr("data-cid"),g=_.reduce(this.content.getTextNodes(b),function(b,d){return b+a(d.nodeValue)},""),i=d.getByCid(f);
i.get("name")!==g?(this.mentionsCache.remove(i),this.content.removeNode(b),this.content.insertHTML(" "),this.reset()):e[f]=b},this);d.each(function(a){e[a.cid]||d.remove(a)})},mentionToText:function(a){a=this.mentionsCache.getByCid($(a).attr("data-cid"));return["@",a.get("username")||a.get("emailHash"),":disqus"].join("")}},{MENTIONS_RE:/@\w+\s?(?:\w+\s?){0,5}(?:\w+)?$/,isMention:function(a,b){var d;do{d=$(a);if(d.hasClass("mention")&&d.attr("data-cid"))return!0;a=a.parentElement}while(b&&a);return!1},
getMentionHtml:function(a){return'<span contenteditable="true"><span contenteditable="false" data-cid="'+a.cid+'" class="mention">'+a.get("name")+"</span></span>&nbsp;"}}),da=Backbone.View.extend({events:{"click li":"onclick"},initialize:function(a){this.active=!1;this.thread=a.thread;this.mentionsCache=a.mentions},suggest:function(a){a=this.findMatches(a);if(!a||!a.length)return void this.clear();this.active=!0;this.el.innerHTML=DISQUS.renderBlock("suggestions",{users:_.map(a,function(a){return _.extend(a.toJSON(),
{cid:a.cid})})});this.$el.find("li[data-cid]").first().addClass("active")},clear:function(){this.active=!1;this.el.innerHTML=""},onclick:function(a){this.select($(a.currentTarget).attr("data-cid"))},findMatches:function(a){if(a&&a.length){for(var b=RegExp(a.join(" ").replace(/[^\w\s]/,""),"i"),d=da.MAX_SUGGESTIONS,e=this.thread.users,f=[],g=0,h,a=a.length===1&&a[0]===""?function(){return!0}:function(a){return b.test(a.get("name"))||b.test(h.get("username"))},g=0;g<e.models.length&&f.length<d;g++)h=
e.models[g],this.mentionsCache.getByCid(h.cid)||a(h)&&f.push(h);return f}},select:function(a){this.active&&(a||(a=this.$el.find(".active").attr("data-cid")),this.trigger("select",a),this.clear())},move:function(a){if(this.active){var b=this.$el.find(".active"),a=b[a==="up"?"previous":"next"]();a.length&&a.attr("data-cid")&&(b.removeClass("active"),a.addClass("active"))}}},{MAX_SUGGESTIONS:5}),Q=k.extend({tagName:"ul",className:"debug",initialize:function(a){this.values=a},render:function(){this.$el.empty();
_.each(this.values,function(a,b){var d=document.createElement("li");d.innerHTML="<strong>"+b+"</strong>: "+a;this.$el.append(d)},this);return this}}),T=Backbone.View.extend({events:{"click [data-nav]":"_navTo"},initialize:function(){this.prevDestination=this.activeNav()},_navTo:function(a){a.preventDefault();a=$(a.target);a=a.is("[data-nav]")?a:a.closest("[data-nav]");a=a.attr("data-nav");if(this.prevDestination==a)return!1;this.navTo(a)},navTo:function(a){this.prevDestination=a;var b=this.$el.find("[data-nav="+
a+"]").parent();b.siblings("li").removeClass("active");b.addClass("active");this.trigger("nav",a)},activeNav:function(){if(this.prevDestination!=null)return this.prevDestination;return this.$el.find(".active [data-nav]").attr("data-nav")},clear:function(){this.$el.find("li").removeClass("active");this.prevDestination=null}}),P=Backbone.View.extend({events:{"click [rel=nofollow]":"sendLinkForInspection"},initialize:function(){this.link=null;this.busy=!1;this.timeoutId=null;this.timeout=1E3;this.token=
1;this.on("option.timeout",function(a){this.timeout=a})},setLink:function(a){this.link=a;this.$link=$(this.link)},onAffiliatorResponse:function(a){a=a||{};if(a.token==this.token){b.off("affiliateLink",this.onAffilatorResponse);if(a.url)this.link.href=a.url;this.undelegateEvents();this.$link.click()}},sendLinkForInspection:function(a){if(a.currentTarget===this.link)return void a.preventDefault();var d=a.which&&a.which===1||a.button===0;if(a.ctrlKey||a.metaKey||a.altKey||a.shiftKey||!d)return!0;if(this.busy){b.off("affiliateLink");
if(this.timeoutId&&window.clearTimeout)window.clearTimeout(this.timeoutId),this.timeoutId=null;this.token++}this.busy=!0;this.setLink(a.currentTarget);a.preventDefault();b.on("affiliateLink",this.onAffiliatorResponse,this);b.sendHostMessage("affiliateLink",{token:this.token,url:this.link.href});a=_.bind(function(a){this.onAffiliatorResponse({token:a})},this,this.token);this.timeoutId=_.delay(a,this.timeout)}});return{Lounge:l,LoungeSubView:k,PostView:G,PostReplyView:x,PostEditView:L,ReactionView:ca,
UserMenuView:z,ThreadVotesView:B,ThreadSubscribeButton:y,QueuedPostView:E,QueuedReplyView:N,TypingUserView:U,CommunityView:S,TopThreadCollectionView:aa,TopUserCollectionView:ba,DashboardView:R,NotificationCollectionView:Y,NotificationCountView:H,UserActivityCollectionView:W,NetworkActivityCollectionView:X,ProfileView:J,HoverCard:t,ProfileCard:F,ContextCard:K,CaptchaView:M,OutboundLinkHandler:P,AlertView:O,BlacklistView:V,ContentEditableView:A,DebugInfoView:Q}});var _comscore,_gaq;
(function(a){var f="",f="UA-1410476-6",g=a.getElementsByTagName("script")[0],j=g.parentNode,h=a.location.protocol=="https:";_comscore=_comscore||[];_comscore.push({c1:"7",c2:"10137436",c3:"1"});var d=document.createElement("script");d.async=!0;d.src=(h?"https://sb":"http://b")+".scorecardresearch.com/beacon.js";j.insertBefore(d,g);_gaq=_gaq||[];_gaq.push(["_setAccount",f]);_gaq.push(["_setDomainName",".disqus.com"]);a=a.createElement("script");a.type="text/javascript";a.async=!0;a.src=(h?"https://ssl":
"http://www")+".google-analytics.com/ga.js";j.insertBefore(a,g)})(document);
(function(){DISQUS.log=function(){var a=DISQUS.next.views.Lounge.getInstance();window.console&&a&&a.switches&&a.switches.enabled("next_logging")&&(window.console.log.apply?window.console.log.apply(window.console,arguments):window.console.log(Array.prototype.slice.call(arguments,0).join(" ")))};DISQUS.logError=function(){var a=DISQUS.next.views.Lounge.getInstance(),f=Array.prototype.slice.call(arguments,0);DISQUS.log.apply(DISQUS,f);a.switches&&a.switches.enabled("next_raven")&&a.states.ravenConfigured&&
Raven.captureMessage({name:"DISQUS.logError",message:f.join(" ")})};$(document).ready(function(){function a(){$(".dropdown").removeClass("open")}$("html").bind("click",a);$("body").delegate("[data-toggle]","click",function(f){f.stopPropagation();f.preventDefault();var f=$(f.currentTarget),f=f.closest("."+f.attr("data-toggle")),g=f.attr("data-dropdown")!="disabled"&&!f.hasClass("open");f.attr("data-dropdown","enabled");a();g&&f.addClass("open")});DISQUS.Bus.bind("window.click",a)})})();