<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>6. UDP段格式</title><link rel="stylesheet" href="styles.css" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/styles.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.73.2" /><link rel="start" href="index.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/index.html" title="Linux C編程一站式學習" /><link rel="up" href="ch36.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/ch36.html" title="第 36 章 TCP/IP協議基礎" /><link rel="prev" href="ch36s05.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/ch36s05.html" title="5. IP地址與路由" /><link rel="next" href="ch36s07.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/ch36s07.html" title="7. TCP協議" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6. UDP段格式</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch36s05.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/ch36s05.html">上一頁</a> </td><th width="60%" align="center">第 36 章 TCP/IP協議基礎</th><td width="20%" align="right"> <a accesskey="n" href="ch36s07.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/ch36s07.html">下一頁</a></td></tr></table><hr /></div><div class="sect1" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id2900637"></a>6. UDP段格式</h2></div></div></div><p>下圖是UDP的段格式（該圖出自<a class="xref" href="bi01.html#bibli.tcpip" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/bi01.html#bibli.tcpip" title="TCP/IP Illustrated, Volume 1: The Protocols">[<abbr class="abbrev">TCPIP</abbr>]</a>）。</p><div class="figure"><a id="id2900651"></a><p class="title"><b>圖 36.11. UDP段格式</b></p><div class="figure-contents"><div><img src="tcpip.udpformat.png" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/images/tcpip.udpformat.png" alt="UDP段格式" /></div></div></div><br class="figure-break" /><p>下面分析一幀基於UDP的TFTP協議幀。</p><div class="literallayout"><p>以太網首部<br />
0000: 00 05 5d 67 d0 b1 00 05 5d 61 58 a8 08 00 <br />
IP首部<br />
0000:                                           45 00<br />
0010: 00 53 93 25 00 00 80 11 25 ec c0 a8 00 37 c0 a8<br />
0020: 00 01<br />
UDP首部<br />
0020：      05 d4 00 45 00 3f ac 40<br />
TFTP協議<br />
0020:                               00 01 'c'':''\''q'<br />
0030: 'w''e''r''q''.''q''w''e'00 'n''e''t''a''s''c''i'<br />
0040: 'i'00 'b''l''k''s''i''z''e'00 '5''1''2'00 't''i'<br />
0050: 'm''e''o''u''t'00 '1''0'00 't''s''i''z''e'00 '0'<br />
0060: 00</p></div><p>以太網首部：源MAC地址是00:05:5d:61:58:a8，目的MAC地址是00:05:5d:67:d0:b1，上層協議類型0x0800表示IP。</p><p>IP首部：每一個字節0x45包含4位版本號和4位首部長度，版本號為4，即IPv4，首部長度為5，說明IP首部不帶有選項字段。服務類型為0，沒有使用服務。16位總長度字段（包括IP首部和IP層payload的長度）為0x0053，即83字節，加上以太網首部14字節可知整個幀長度是97字節。IP報標識是0x9325，標誌字段和片偏移字段設置為0x0000，就是DF=0允許分片，MF=0此數據報沒有更多分片，沒有分片偏移。TTL是0x80，也就是128。上層協議0x11表示UDP協議。IP首部校驗和為0x25ec，源主機IP是c0 a8 00 37（192.168.0.55），目的主機IP是c0 a8 00 01（192.168.0.1）。</p><p>UDP首部：源端口號0x05d4（1492）是客戶端的端口號，目的端口號0x0045（69）是TFTP服務的well-known端口號。UDP報長度為0x003f，即63字節，包括UDP首部和UDP層payload的長度。UDP首部和UDP層payload的校驗和為0xac40。</p><p>TFTP是基於文本的協議，各字段之間用字節0分隔，開頭的00 01表示請求讀取一個文件，接下來的各字段是：</p><div class="literallayout"><p>c:\qwerq.qwe<br />
netascii<br />
blksize 512<br />
timeout 10<br />
tsize 0</p></div><p>一般的網絡通信都是像TFTP協議這樣，通信的雙方分別是客戶端和服務器，客戶端主動發起請求（上面的例子就是客戶端發起的請求幀），而服務器被動地等待、接收和應答請求。客戶端的IP地址和端口號唯一標識了該主機上的TFTP客戶端進程，服務器的IP地址和端口號唯一標識了該主機上的TFTP服務進程，由於客戶端是主動發起請求的一方，它必須知道服務器的IP地址和TFTP服務進程的端口號，所以，一些常見的網絡協議有默認的服務器端口，例如HTTP服務默認TCP協議的80端口，FTP服務默認TCP協議的21端口，TFTP服務默認UDP協議的69端口（如上例所示）。在使用客戶端程序時，必須指定服務器的主機名或IP地址，如果不明確指定端口號則採用默認端口，請讀者查閱ftp、tftp等程序的man page瞭解如何指定端口號。/etc/services中列出了所有well-known的服務端口和對應的傳輸層協議，這是由IANA（Internet Assigned Numbers Authority）規定的，其中有些服務既可以用TCP也可以用UDP，為了清晰，IANA規定這樣的服務採用相同的TCP或UDP默認端口號，而另外一些TCP和UDP的相同端口號卻對應不同的服務。</p><p>很多服務有well-known的端口號，然而客戶端程序的端口號卻不必是well-known的，往往是每次運行客戶端程序時由系統自動分配一個空閒的端口號，用完就釋放掉，稱為ephemeral的端口號，想想這是為什麼。</p><p>前面提過，UDP協議不面向連接，也不保證傳輸的可靠性，例如：</p><div class="itemizedlist"><ul type="disc"><li><p>發送端的UDP協議層只管把應用層傳來的數據封裝成段交給IP協議層就算完成任務了，如果因為網絡故障該段無法發到對方，UDP協議層也不會給應用層返回任何錯誤信息。</p></li><li><p>接收端的UDP協議層只管把收到的數據根據端口號交給相應的應用程序就算完成任務了，如果發送端發來多個數據包並且在網絡上經過不同的路由，到達接收端時順序已經錯亂了，UDP協議層也不保證按發送時的順序交給應用層。</p></li><li><p>通常接收端的UDP協議層將收到的數據放在一個固定大小的緩衝區中等待應用程序來提取和處理，如果應用程序提取和處理的速度很慢，而發送端發送的速度很快，就會丟失數據包，UDP協議層並不報告這種錯誤。</p></li></ul></div><p>因此，使用UDP協議的應用程序必須考慮到這些可能的問題並實現適當的解決方案，例如等待應答、超時重發、為數據包編號、流量控制等。一般使用UDP協議的應用程序實現都比較簡單，只是發送一些對可靠性要求不高的消息，而不發送大量的數據。例如，基於UDP的TFTP協議一般只用於傳送小文件（所以才叫trivial的ftp），而基於TCP的FTP協議適用於各種文件的傳輸。下面看TCP協議如何用面向連接的服務來代替應用程序解決傳輸的可靠性問題。</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch36s05.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/ch36s05.html">上一頁</a> </td><td width="20%" align="center"><a accesskey="u" href="ch36.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/ch36.html">上一級</a></td><td width="40%" align="right"> <a accesskey="n" href="ch36s07.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/ch36s07.html">下一頁</a></td></tr><tr><td width="40%" align="left" valign="top">5. IP地址與路由 </td><td width="20%" align="center"><a accesskey="h" href="index.html" tppabs="http://resource.lancetw.org/ebook/linux-c-on-site-learning-zh-tw/index.html">起始頁</a></td><td width="40%" align="right" valign="top"> 7. TCP協議</td></tr></table></div></body></html>
